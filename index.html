<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>S15 åŸç”» + ç‚«ç¥è§£è¯´</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  
  html, body{
    width:100%;
    height:100%;
    overflow:hidden;
    position:fixed;
    -webkit-overflow-scrolling:touch;
  }
  
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
    background:#000;
    color:#eee;
    display:flex;
    flex-direction:column;
    /* ğŸ†• ç§»åŠ¨ç«¯å®‰å…¨åŒºåŸŸé€‚é… */
    padding-top:env(safe-area-inset-top);
    padding-bottom:env(safe-area-inset-bottom);
    padding-left:env(safe-area-inset-left);
    padding-right:env(safe-area-inset-right);
  }
  
  header{
    background:#18181b;
    padding:10px 15px;
    font-size:14px;
    display:flex;
    align-items:center;
    gap:8px;
    z-index:10;
    flex-wrap:wrap;
    flex-shrink:0;
  }
  
  .live{
    background:#ff4655;
    color:#fff;
    padding:2px 8px;
    border-radius:4px;
    font-weight:700;
    font-size:12px;
  }
  
  .status{
    display:flex;
    align-items:center;
    gap:6px;
    margin-left:auto;
    font-size:12px;
    padding:4px 10px;
    border-radius:4px;
    background:rgba(255,255,255,.1);
  }
  
  .dot{
    width:8px;
    height:8px;
    border-radius:50%;
    background:#666;
    animation:pulse 1.5s ease-in-out infinite;
  }
  .dot.loading{background:#ffa500}
  .dot.success{background:#0f0;animation:none}
  .dot.error{background:#f00;animation:blink 1s infinite}
  
  /* ğŸ†• æŒ‰é’®æ ·å¼ */
  .header-btn{
    padding:4px 10px;
    background:rgba(102,126,234,.3);
    border:1px solid rgba(102,126,234,.5);
    border-radius:4px;
    color:#fff;
    cursor:pointer;
    font-size:12px;
    transition:all .2s;
    white-space:nowrap;
    -webkit-tap-highlight-color:transparent;
  }
  .header-btn:hover, .header-btn:active{
    background:rgba(102,126,234,.5);
    transform:scale(1.05);
  }
  
  @keyframes pulse{
    0%,100%{opacity:.4}
    50%{opacity:1}
  }
  @keyframes blink{
    0%,100%{opacity:1}
    50%{opacity:.3}
  }
  
  .box{
    flex:1;
    display:flex;
    gap:0;
    padding:0;
    position:relative;
    overflow:hidden;
    min-height:0;
  }
  
  iframe{
    width:100%;
    height:100%;
    border:0;
  }
  
  /* ========== æ™ºèƒ½æŠ˜å éŸ³é¢‘æ’­æ”¾å™¨ ========== */
  .audio-widget{
    position:fixed;
    top:60px;
    right:15px;
    background:rgba(0,0,0,.95);
    border-radius:10px;
    box-shadow:0 8px 24px rgba(0,0,0,.8), 0 0 0 1px rgba(102,126,234,.3);
    overflow:hidden;
    z-index:1000;
    user-select:none;
    backdrop-filter:blur(10px);
    transition:width .3s cubic-bezier(0.4, 0, 0.2, 1), 
               height .3s cubic-bezier(0.4, 0, 0.2, 1);
    -webkit-tap-highlight-color:transparent;
  }
  
  .audio-widget.collapsed{
    width:200px !important;
    height:40px !important;
  }
  
  .audio-widget.expanded{
    width:320px !important;
    height:260px !important;
  }
  
  /* æ ‡é¢˜æ ï¼šå¯æ‹–åŠ¨åŒºåŸŸ */
  .audio-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 12px;
    background:linear-gradient(135deg, rgba(102,126,234,.2) 0%, rgba(118,75,162,.2) 100%);
    border-bottom:1px solid rgba(255,255,255,.1);
    cursor:move;
    min-height:40px;
    touch-action:none;
  }
  
  .audio-header:hover{
    background:linear-gradient(135deg, rgba(102,126,234,.3) 0%, rgba(118,75,162,.3) 100%);
  }
  
  .audio-title{
    display:flex;
    align-items:center;
    gap:8px;
    font-size:13px;
    font-weight:600;
    flex:1;
  }
  
  .audio-icon{
    font-size:16px;
    animation:pulse-icon 2s infinite;
  }
  
  @keyframes pulse-icon{
    0%,100%{transform:scale(1)}
    50%{transform:scale(1.1)}
  }
  
  /* æŠ˜å /å±•å¼€æŒ‰é’® */
  .audio-toggle{
    cursor:pointer;
    padding:4px 8px;
    border-radius:4px;
    transition:all .2s;
    font-size:14px;
    line-height:1;
    background:rgba(255,255,255,.1);
  }
  
  .audio-toggle:hover, .audio-toggle:active{
    background:rgba(255,255,255,.2);
    transform:scale(1.1);
  }
  
  .audio-widget.collapsed .audio-toggle{
    transform:rotate(180deg);
  }
  
  .audio-widget.collapsed .audio-toggle:hover{
    transform:rotate(180deg) scale(1.1);
  }
  
  /* æ’­æ”¾å™¨å®¹å™¨ */
  .audio-player{
    width:100%;
    height:180px;
    opacity:1;
    transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow:hidden;
  }
  
  .audio-widget.collapsed .audio-player{
    height:0;
    opacity:0;
    pointer-events:none;
  }
  
  /* åˆ·æ–°æŒ‰é’®å®¹å™¨ */
  .audio-controls{
    padding:10px 12px;
    display:flex;
    gap:8px;
    opacity:1;
    transition:all .3s;
  }
  
  .audio-widget.collapsed .audio-controls{
    height:0;
    padding:0;
    opacity:0;
    overflow:hidden;
  }
  
  .control-btn{
    flex:1;
    padding:8px;
    background:rgba(102,126,234,.2);
    border:1px solid rgba(102,126,234,.4);
    border-radius:6px;
    color:#fff;
    cursor:pointer;
    font-size:12px;
    text-align:center;
    transition:all .2s;
    -webkit-tap-highlight-color:transparent;
  }
  
  .control-btn:hover, .control-btn:active{
    background:rgba(102,126,234,.4);
    border-color:rgba(102,126,234,.6);
    transform:translateY(-2px);
  }
  
  .control-btn:active{
    transform:translateY(0);
  }
  
  /* æ‹–åŠ¨æ—¶çš„è§†è§‰åé¦ˆ */
  .audio-widget.dragging{
    opacity:.9;
    box-shadow:0 12px 40px rgba(102,126,234,.5);
    cursor:move !important;
    transition:none !important;
  }
  
  .audio-widget.dragging .audio-header{
    cursor:move !important;
  }
  
  /* æç¤ºæ°”æ³¡ */
  .hint-bubble{
    position:absolute;
    top:-50px;
    left:50%;
    transform:translateX(-50%);
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    color:#fff;
    padding:8px 15px;
    border-radius:20px;
    font-size:12px;
    white-space:nowrap;
    box-shadow:0 4px 12px rgba(102,126,234,.4);
    animation:float 2s ease-in-out infinite;
    opacity:0;
    pointer-events:none;
    transition:opacity .3s;
  }
  
  .hint-bubble.show{
    opacity:1;
  }
  
  .hint-bubble::after{
    content:'';
    position:absolute;
    bottom:-6px;
    left:50%;
    transform:translateX(-50%);
    width:0;
    height:0;
    border-left:6px solid transparent;
    border-right:6px solid transparent;
    border-top:6px solid #764ba2;
  }
  
  @keyframes float{
    0%,100%{transform:translateX(-50%) translateY(0)}
    50%{transform:translateX(-50%) translateY(-5px)}
  }

  /* ========== ğŸ†• ä½¿ç”¨è¯´æ˜å¼¹çª— ========== */
  .modal-overlay{
    position:fixed;
    top:0;
    left:0;
    right:0;
    bottom:0;
    background:rgba(0,0,0,.85);
    z-index:9999;
    display:none;
    align-items:center;
    justify-content:center;
    padding:20px;
    backdrop-filter:blur(5px);
    -webkit-backdrop-filter:blur(5px);
  }
  
  .modal-overlay.show{
    display:flex;
  }
  
  .modal{
    background:linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-radius:16px;
    max-width:500px;
    width:100%;
    max-height:80vh;
    overflow-y:auto;
    box-shadow:0 20px 60px rgba(0,0,0,.5);
    border:1px solid rgba(102,126,234,.3);
    animation:modalSlideIn .3s ease-out;
  }
  
  @keyframes modalSlideIn{
    from{
      opacity:0;
      transform:translateY(-30px) scale(0.95);
    }
    to{
      opacity:1;
      transform:translateY(0) scale(1);
    }
  }
  
  .modal-header{
    padding:20px;
    background:linear-gradient(135deg, rgba(102,126,234,.3) 0%, rgba(118,75,162,.3) 100%);
    border-bottom:1px solid rgba(255,255,255,.1);
    display:flex;
    align-items:center;
    justify-content:space-between;
  }
  
  .modal-title{
    font-size:18px;
    font-weight:700;
    color:#fff;
    display:flex;
    align-items:center;
    gap:10px;
  }
  
  .modal-close{
    width:32px;
    height:32px;
    border-radius:50%;
    background:rgba(255,255,255,.1);
    border:none;
    color:#fff;
    font-size:20px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:all .2s;
    -webkit-tap-highlight-color:transparent;
  }
  
  .modal-close:hover, .modal-close:active{
    background:rgba(255,255,255,.2);
    transform:rotate(90deg);
  }
  
  .modal-body{
    padding:20px;
    color:#eee;
    line-height:1.6;
  }
  
  .step{
    margin-bottom:20px;
    padding:15px;
    background:rgba(102,126,234,.1);
    border-left:4px solid #667eea;
    border-radius:8px;
  }
  
  .step-number{
    display:inline-block;
    width:28px;
    height:28px;
    background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color:#fff;
    border-radius:50%;
    text-align:center;
    line-height:28px;
    font-weight:700;
    margin-right:10px;
    font-size:14px;
  }
  
  .step-title{
    font-weight:600;
    color:#667eea;
    margin-bottom:8px;
    font-size:15px;
  }
  
  .step-desc{
    font-size:14px;
    color:#ccc;
    margin-left:38px;
  }
  
  .tips{
    background:rgba(255,193,7,.15);
    border-left:4px solid #ffc107;
    padding:12px 15px;
    border-radius:8px;
    margin-top:15px;
  }
  
  .tips-title{
    font-weight:600;
    color:#ffc107;
    margin-bottom:8px;
    display:flex;
    align-items:center;
    gap:8px;
  }
  
  .tips-list{
    font-size:13px;
    color:#ccc;
    margin-left:20px;
  }
  
  .tips-list li{
    margin:5px 0;
  }
  
  .keyboard{
    display:inline-block;
    padding:2px 6px;
    background:rgba(255,255,255,.1);
    border:1px solid rgba(255,255,255,.2);
    border-radius:4px;
    font-size:12px;
    font-family:monospace;
    color:#667eea;
  }

  /* è°ƒè¯•æ—¥å¿— */
  .debug{
    position:fixed;
    top:60px;
    left:15px;
    background:rgba(0,0,0,.9);
    border:1px solid #333;
    border-radius:6px;
    padding:10px;
    font-size:11px;
    font-family:monospace;
    max-width:350px;
    max-height:200px;
    overflow-y:auto;
    color:#0f0;
    display:none;
    z-index:999;
  }
  .debug.show{display:block}
  .debug div{margin:2px 0}
  
  /* ========== ğŸ†• ç§»åŠ¨ç«¯é€‚é… ========== */
  @media (max-width: 768px) {
    header{
      font-size:12px;
      padding:8px 10px;
      gap:6px;
    }
    
    .status{
      font-size:11px;
      padding:3px 8px;
    }
    
    .header-btn{
      font-size:11px;
      padding:3px 8px;
    }
    
    .audio-widget{
      /* ğŸ†• ç§»åŠ¨ç«¯é»˜è®¤åœ¨åº•éƒ¨ */
      top:auto !important;
      bottom:80px !important;
      right:10px !important;
      left:auto !important;
    }
    
    .audio-widget.collapsed{
      width:160px !important;
      height:36px !important;
    }
    
    .audio-widget.expanded{
      width:calc(100vw - 20px) !important;
      max-width:350px !important;
      height:240px !important;
      right:10px !important;
      bottom:80px !important;
    }
    
    .audio-header{
      padding:8px 10px;
      min-height:36px;
    }
    
    .audio-title{
      font-size:12px;
      gap:6px;
    }
    
    .audio-icon{
      font-size:14px;
    }
    
    .audio-toggle{
      padding:3px 6px;
      font-size:12px;
    }
    
    .audio-player{
      height:160px;
    }
    
    .audio-controls{
      padding:8px 10px;
    }
    
    .control-btn{
      padding:6px;
      font-size:11px;
    }
    
    .modal{
      max-width:calc(100vw - 30px);
      margin:15px;
    }
    
    .modal-header{
      padding:15px;
    }
    
    .modal-title{
      font-size:16px;
    }
    
    .modal-body{
      padding:15px;
    }
    
    .step{
      padding:12px;
      margin-bottom:15px;
    }
    
    .step-title{
      font-size:14px;
    }
    
    .step-desc{
      font-size:13px;
    }
    
    /* ğŸ†• ç§»åŠ¨ç«¯åº•éƒ¨ç•™å‡ºç©ºé—´ */
    .box{
      padding-bottom:10px;
    }
    
    /* ğŸ†• ç§»åŠ¨ç«¯éšè—è°ƒè¯•é¢æ¿ */
    .debug{
      display:none !important;
    }
  }
  
  /* ğŸ†• æ¨ªå±æ¨¡å¼ */
  @media (max-width: 768px) and (orientation: landscape) {
    .audio-widget.expanded{
      height:200px !important;
    }
    
    .audio-player{
      height:130px;
    }
  }
  
  /* ğŸ†• å®‰å…¨åŒºåŸŸåº•éƒ¨é€‚é…ï¼ˆiPhone X+ ç­‰ï¼‰ */
  @supports (padding-bottom: env(safe-area-inset-bottom)) {
    @media (max-width: 768px) {
      .audio-widget{
        bottom:calc(80px + env(safe-area-inset-bottom)) !important;
      }
    }
  }
</style>
</head>
<body>

<header>
  <span class="live">LIVE</span>
  <span>S15 å®˜æ–¹ç”»é¢ + Lastç‚«ç¥è§£è¯´</span>
  
  <div class="status">
    <span class="dot loading" id="statusDot"></span>
    <span id="statusText">æ’­æ”¾ä¸­</span>
  </div>
  
  <!-- ğŸ†• ä½¿ç”¨è¯´æ˜æŒ‰é’® -->
  <button class="header-btn" id="helpBtn">ğŸ“– ä½¿ç”¨è¯´æ˜</button>
  
  <!-- ä¸»ç”»é¢åˆ·æ–°æŒ‰é’® -->
  <button class="header-btn" id="refreshMain" title="åˆ·æ–°ä¸»ç”»é¢">ğŸ”„ ä¸»ç”»é¢</button>
</header>

<section class="box">
  <!-- å®˜æ–¹ç”»é¢ï¼ˆé™éŸ³ï¼‰ -->
  <iframe id="video"
          src="https://www.bilibili.com/blackboard/live/live-activity-player.html?cid=7734200&quality=1&muted=1"
          sandbox="allow-scripts allow-same-origin allow-presentation"
          allow="autoplay *; encrypted-media *; fullscreen *"
          referrerpolicy="no-referrer">
  </iframe>
</section>

<!-- ========== æ™ºèƒ½æŠ˜å éŸ³é¢‘æ’­æ”¾å™¨ ========== -->
<div class="audio-widget collapsed" id="audioWidget">
  <!-- æç¤ºæ°”æ³¡ -->
  <div class="hint-bubble" id="hintBubble">ğŸ‘† ç‚¹å‡»å±•å¼€æ’­æ”¾å™¨</div>
  
  <!-- æ ‡é¢˜æ ï¼ˆå¯æ‹–åŠ¨ï¼‰ -->
  <div class="audio-header" id="audioHeader">
    <div class="audio-title">
      <span class="audio-icon">ğŸ™ï¸</span>
      <span>ç‚«ç¥è§£è¯´</span>
    </div>
    <span class="audio-toggle" id="audioToggle">â–²</span>
  </div>
  
  <!-- æ’­æ”¾å™¨åŒºåŸŸï¼ˆæœ‰å£°éŸ³ï¼Œä¸é™éŸ³ï¼‰ -->
  <div class="audio-player">
    <iframe id="audio"
            src="https://www.bilibili.com/blackboard/live/live-activity-player.html?cid=84074&quality=1"
            sandbox="allow-scripts allow-same-origin allow-presentation"
            allow="autoplay *; encrypted-media *"
            referrerpolicy="no-referrer"
            style="width:100%;height:100%;border:0">
    </iframe>
  </div>
  
  <!-- æ§åˆ¶æŒ‰é’® -->
  <div class="audio-controls">
    <div class="control-btn" id="refreshAudio">ğŸ”„ åˆ·æ–°è§£è¯´</div>
  </div>
</div>

<!-- ========== ğŸ†• ä½¿ç”¨è¯´æ˜å¼¹çª— ========== -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">
        <span>ğŸ“–</span>
        <span>ä½¿ç”¨è¯´æ˜</span>
      </div>
      <button class="modal-close" id="modalClose">Ã—</button>
    </div>
    
    <div class="modal-body">
      <div class="step">
        <div class="step-title">
          <span class="step-number">1</span>
          è§‚çœ‹åŒè§†è§’ç›´æ’­
        </div>
        <div class="step-desc">
          â€¢ å¤§å±å¹•ï¼šæ˜¾ç¤ºå®˜æ–¹ç”»é¢ï¼ˆæ— å£°éŸ³ï¼‰<br>
          â€¢ å°çª—å£ï¼šæ’­æ”¾ç‚«ç¥è§£è¯´ï¼ˆæœ‰å£°éŸ³ï¼‰
        </div>
      </div>
      
      <div class="step">
        <div class="step-title">
                <div class="step">
        <div class="step-title">
          <span class="step-number">1</span>
          è§‚çœ‹åŒè§†è§’ç›´æ’­
        </div>
        <div class="step-desc">
          â€¢ å¤§å±å¹•ï¼šæ˜¾ç¤ºå®˜æ–¹ç”»é¢ï¼ˆæ— å£°éŸ³ï¼‰<br>
          â€¢ å°çª—å£ï¼šæ’­æ”¾ç‚«ç¥è§£è¯´ï¼ˆæœ‰å£°éŸ³ï¼‰
        </div>
      </div>
      
      <div class="step">
        <div class="step-title">
          <span class="step-number">2</span>
          å±•å¼€/æŠ˜å å°çª—å£
        </div>
        <div class="step-desc">
          ç‚¹å‡»å³ä¸Šè§’å°çª—å£çš„ <strong>â–²</strong> æŒ‰é’®ï¼Œå¯ä»¥å±•å¼€æˆ–æŠ˜å è§£è¯´æ’­æ”¾å™¨ã€‚
        </div>
      </div>
      
      <div class="step">
        <div class="step-title">
          <span class="step-number">3</span>
          ç§»åŠ¨å°çª—å£ä½ç½®
        </div>
        <div class="step-desc">
          <strong>ç”µè„‘ç«¯ï¼š</strong>æŒ‰ä½æ ‡é¢˜æ æ‹–åŠ¨å³å¯ç§»åŠ¨ä½ç½®<br>
          <strong>æ‰‹æœºç«¯ï¼š</strong>é•¿æŒ‰æ ‡é¢˜æ åæ‹–åŠ¨è°ƒæ•´ä½ç½®
        </div>
      </div>
      
      <div class="step">
        <div class="step-title">
          <span class="step-number">4</span>
          åˆ·æ–°æ’­æ”¾å™¨
        </div>
        <div class="step-desc">
          â€¢ å¦‚æœç”»é¢å¡é¡¿ï¼Œç‚¹å‡»é¡¶éƒ¨ <strong>ğŸ”„ ä¸»ç”»é¢</strong> åˆ·æ–°<br>
          â€¢ å¦‚æœè§£è¯´æ— å£°ï¼Œå±•å¼€å°çª—å£ç‚¹å‡» <strong>ğŸ”„ åˆ·æ–°è§£è¯´</strong>
        </div>
      </div>
      
      <div class="step">
        <div class="step-title">
          <span class="step-number">5</span>
          é‡ç½®çª—å£ä½ç½®
        </div>
        <div class="step-desc">
          <strong>ç”µè„‘ç«¯ï¼š</strong>å³é”®ç‚¹å‡»å°çª—å£å¯é‡ç½®åˆ°é»˜è®¤ä½ç½®<br>
          <strong>æ‰‹æœºç«¯ï¼š</strong>é•¿æŒ‰å°çª—å£2ç§’å¯é‡ç½®ä½ç½®
        </div>
      </div>
      
      <div class="tips">
        <div class="tips-title">
          ğŸ’¡ å¿«æ·é”®æç¤ºï¼ˆä»…ç”µè„‘ç«¯ï¼‰
        </div>
        <ul class="tips-list">
          <li><span class="keyboard">Ctrl/Cmd</span> + <span class="keyboard">Space</span> åˆ‡æ¢æŠ˜å /å±•å¼€</li>
          <li><span class="keyboard">ESC</span> å¿«é€ŸæŠ˜å å°çª—å£</li>
          <li><span class="keyboard">Ctrl</span> + <span class="keyboard">R</span> åˆ·æ–°ä¸»ç”»é¢</li>
          <li><span class="keyboard">Ctrl</span> + <span class="keyboard">Shift</span> + <span class="keyboard">R</span> åˆ·æ–°è§£è¯´</li>
          <li><span class="keyboard">Ctrl</span> + <span class="keyboard">Shift</span> + <span class="keyboard">D</span> å¼€å¯è°ƒè¯•æ¨¡å¼</li>
        </ul>
      </div>
      
      <div class="tips" style="border-left-color:#f44336;background:rgba(244,67,54,.15);">
        <div class="tips-title" style="color:#f44336;">
          âš ï¸ å¸¸è§é—®é¢˜
        </div>
        <ul class="tips-list">
          <li><strong>è§£è¯´æ²¡å£°éŸ³ï¼Ÿ</strong> å±•å¼€å°çª—å£ï¼Œç‚¹å‡»åˆ·æ–°è§£è¯´æŒ‰é’®</li>
          <li><strong>ç”»é¢é»‘å±ï¼Ÿ</strong> ç‚¹å‡»é¡¶éƒ¨åˆ·æ–°æŒ‰é’®é‡æ–°åŠ è½½</li>
          <li><strong>ç§»åŠ¨ç«¯æ˜¾ç¤ºå¼‚å¸¸ï¼Ÿ</strong> å°è¯•æ¨ªå±è§‚çœ‹æˆ–åˆ·æ–°é¡µé¢</li>
          <li><strong>çª—å£ä½ç½®å¼‚å¸¸ï¼Ÿ</strong> å³é”®æˆ–é•¿æŒ‰å°çª—å£é‡ç½®ä½ç½®</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- è°ƒè¯•æ—¥å¿— -->
<div class="debug" id="debug"></div>

<script>
// ========== è°ƒè¯•æ—¥å¿—ç³»ç»Ÿ ==========
const debugPanel = document.getElementById('debug');
let debugEnabled = false;

function log(msg) {
  const now = new Date().toLocaleTimeString();
  console.log(`[${now}] ${msg}`);
  
  if (debugEnabled) {
    debugPanel.classList.add('show');
    const div = document.createElement('div');
    div.textContent = `${now} ${msg}`;
    debugPanel.appendChild(div);
    debugPanel.scrollTop = debugPanel.scrollHeight;
  }
}

log('é¡µé¢å¼€å§‹åŠ è½½');

// ========== ğŸ†• æ£€æµ‹è®¾å¤‡ç±»å‹ ==========
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
log(`è®¾å¤‡ç±»å‹: ${isMobile ? 'ç§»åŠ¨ç«¯' : 'æ¡Œé¢ç«¯'}, iOS: ${isIOS}`);

// ========== ğŸ†• ä½¿ç”¨è¯´æ˜å¼¹çª— ==========
const helpBtn = document.getElementById('helpBtn');
const modalOverlay = document.getElementById('modalOverlay');
const modalClose = document.getElementById('modalClose');

helpBtn.onclick = () => {
  modalOverlay.classList.add('show');
  log('ğŸ“– æ‰“å¼€ä½¿ç”¨è¯´æ˜');
};

modalClose.onclick = () => {
  modalOverlay.classList.remove('show');
  log('ğŸ“– å…³é—­ä½¿ç”¨è¯´æ˜');
};

modalOverlay.onclick = (e) => {
  if (e.target === modalOverlay) {
    modalOverlay.classList.remove('show');
    log('ğŸ“– ç‚¹å‡»èƒŒæ™¯å…³é—­è¯´æ˜');
  }
};

// ESC é”®å…³é—­å¼¹çª—
document.addEventListener('keydown', (e) => {
  if (e.code === 'Escape' && modalOverlay.classList.contains('show')) {
    modalOverlay.classList.remove('show');
    log('ğŸ“– ESC å…³é—­ä½¿ç”¨è¯´æ˜');
  }
});

// ========== iframe åŠ è½½ç›‘æ§ ==========
const videoFrame = document.getElementById('video');
const audioFrame = document.getElementById('audio');
const statusDot = document.getElementById('statusDot');
const statusText = document.getElementById('statusText');

let videoLoaded = false;
let audioLoaded = false;

videoFrame.onload = () => {
  videoLoaded = true;
  log('âœ“ å®˜æ–¹ç”»é¢åŠ è½½å®Œæˆï¼ˆé™éŸ³ï¼‰');
  checkBothLoaded();
};

audioFrame.onload = () => {
  audioLoaded = true;
  log('âœ“ è§£è¯´éŸ³é¢‘åŠ è½½å®Œæˆ');
  
  // å¼ºåˆ¶ç¡®ä¿éŸ³é¢‘æœ‰å£°éŸ³
  setTimeout(() => {
    try {
      audioFrame.contentWindow.postMessage({
        type: 'unmute',
        muted: false
      }, '*');
      log('ğŸ”Š å·²å‘é€å–æ¶ˆé™éŸ³æŒ‡ä»¤åˆ°è§£è¯´æ’­æ”¾å™¨');
    } catch (e) {
      log('âš ï¸ æ— æ³•ç›´æ¥æ§åˆ¶éŸ³é¢‘ï¼š' + e.message);
    }
  }, 1000);
  
  checkBothLoaded();
};

audioFrame.onerror = () => {
  log('âœ— éŸ³é¢‘åŠ è½½å¤±è´¥');
  statusDot.className = 'dot error';
  statusText.textContent = 'éŸ³é¢‘åŠ è½½å¤±è´¥';
};

function checkBothLoaded() {
  if (videoLoaded && audioLoaded) {
    log('ä¸¤ä¸ªç›´æ’­æµéƒ½å·²åŠ è½½');
    
    setTimeout(() => {
      statusDot.className = 'dot success';
      statusText.textContent = 'æ’­æ”¾ä¸­';
      log('âœ… ç›´æ’­æ’­æ”¾ä¸­ï¼ˆå®˜æ–¹ç”»é¢é™éŸ³ï¼Œè§£è¯´æœ‰å£°ï¼‰');
      
      // æ˜¾ç¤ºæç¤ºæ°”æ³¡
      showHintBubble();
      
      // ğŸ†• é¦–æ¬¡è®¿é—®æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
      const hasVisited = localStorage.getItem('hasVisited');
      if (!hasVisited) {
        setTimeout(() => {
          modalOverlay.classList.add('show');
          localStorage.setItem('hasVisited', 'true');
          log('ğŸ“– é¦–æ¬¡è®¿é—®ï¼Œæ˜¾ç¤ºä½¿ç”¨è¯´æ˜');
        }, 2000);
      }
    }, 1000);
  }
}

// ========== åˆ·æ–°åŠŸèƒ½ ==========
document.getElementById('refreshMain').onclick = () => {
  log('ğŸ”„ åˆ·æ–°ä¸»ç”»é¢...');
  videoFrame.src = videoFrame.src;
  statusDot.className = 'dot loading';
  statusText.textContent = 'åˆ·æ–°ä¸­...';
};

document.getElementById('refreshAudio').onclick = () => {
  log('ğŸ”„ åˆ·æ–°è§£è¯´ç”»é¢...');
  audioFrame.src = audioFrame.src;
  
  // åˆ·æ–°åå†æ¬¡ç¡®ä¿æœ‰å£°éŸ³
  setTimeout(() => {
    try {
      audioFrame.contentWindow.postMessage({
        type: 'unmute',
        muted: false
      }, '*');
      log('ğŸ”Š åˆ·æ–°åé‡æ–°å‘é€å–æ¶ˆé™éŸ³æŒ‡ä»¤');
    } catch (e) {
      log('âš ï¸ åˆ·æ–°åæ— æ³•æ§åˆ¶éŸ³é¢‘');
    }
  }, 1500);
};

// ========== æ™ºèƒ½æŠ˜å åŠŸèƒ½ ========== 
const audioWidget = document.getElementById('audioWidget');
const audioToggle = document.getElementById('audioToggle');
const hintBubble = document.getElementById('hintBubble');

// LocalStorage é”®å
const STORAGE_KEY_COLLAPSED = 'audioWidget_collapsed';
const STORAGE_KEY_POSITION = 'audioWidget_position';

// æ¢å¤ä¸Šæ¬¡çš„æŠ˜å çŠ¶æ€
function restoreState() {
  const savedCollapsed = localStorage.getItem(STORAGE_KEY_COLLAPSED);
  const savedPosition = localStorage.getItem(STORAGE_KEY_POSITION);
  
  // æ¢å¤æŠ˜å çŠ¶æ€
  if (savedCollapsed === 'false') {
    audioWidget.classList.remove('collapsed');
    audioWidget.classList.add('expanded');
    log('æ¢å¤å±•å¼€çŠ¶æ€');
  } else {
    audioWidget.classList.add('collapsed');
    audioWidget.classList.remove('expanded');
    log('é»˜è®¤æŠ˜å çŠ¶æ€');
  }
  
  // ğŸ†• ç§»åŠ¨ç«¯ä¸æ¢å¤ä½ç½®ï¼Œä½¿ç”¨CSSé»˜è®¤ä½ç½®
  if (!isMobile && savedPosition) {
    try {
      const pos = JSON.parse(savedPosition);
      audioWidget.style.left = pos.left;
      audioWidget.style.top = pos.top;
      audioWidget.style.right = 'auto';
      audioWidget.style.bottom = 'auto';
      log(`æ¢å¤ä½ç½®: ${pos.left}, ${pos.top}`);
    } catch (e) {
      log('ä½ç½®æ¢å¤å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®');
    }
  } else {
    log(isMobile ? 'ç§»åŠ¨ç«¯ä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆåº•éƒ¨ï¼‰' : 'ä½¿ç”¨é»˜è®¤ä½ç½®ï¼ˆå³ä¸Šè§’ï¼‰');
  }
}

// åˆ‡æ¢æŠ˜å /å±•å¼€
audioToggle.onclick = (e) => {
  e.stopPropagation();
  const isCollapsed = audioWidget.classList.contains('collapsed');
  
  if (isCollapsed) {
    audioWidget.classList.remove('collapsed');
    audioWidget.classList.add('expanded');
    localStorage.setItem(STORAGE_KEY_COLLAPSED, 'false');
    log('å±•å¼€æ’­æ”¾å™¨');
  } else {
    audioWidget.classList.remove('expanded');
    audioWidget.classList.add('collapsed');
    localStorage.setItem(STORAGE_KEY_COLLAPSED, 'true');
    log('æŠ˜å æ’­æ”¾å™¨');
  }
  
  hintBubble.classList.remove('show');
};

// æ˜¾ç¤ºæç¤ºæ°”æ³¡
function showHintBubble() {
  const isCollapsed = audioWidget.classList.contains('collapsed');
  if (isCollapsed) {
    hintBubble.classList.add('show');
    
    setTimeout(() => {
      hintBubble.classList.remove('show');
    }, 5000);
    
    log('æ˜¾ç¤ºæ“ä½œæç¤º');
  }
}

// ========== æ‹–åŠ¨åŠŸèƒ½ï¼ˆæ¡Œé¢ç«¯ + ç§»åŠ¨ç«¯ï¼‰ ==========
const audioHeader = document.getElementById('audioHeader');
let isDragging = false;
let dragStartX = 0;
let dragStartY = 0;
let widgetStartX = 0;
let widgetStartY = 0;
let hasMoved = false;

// ğŸ†• é•¿æŒ‰é‡ç½®åŠŸèƒ½ï¼ˆç§»åŠ¨ç«¯ï¼‰
let longPressTimer = null;

// æ¡Œé¢ç«¯ï¼šé¼ æ ‡æ‹–åŠ¨
audioHeader.addEventListener('mousedown', (e) => {
  if (e.target.closest('#audioToggle')) {
    return;
  }
  
  isDragging = true;
  hasMoved = false;
  
  dragStartX = e.clientX;
  dragStartY = e.clientY;
  
  const rect = audioWidget.getBoundingClientRect();
  widgetStartX = rect.left;
  widgetStartY = rect.top;
  
  audioWidget.classList.add('dragging');
  e.preventDefault();
  
  log('ğŸ–±ï¸ mousedown - å‡†å¤‡æ‹–åŠ¨');
});

document.addEventListener('mousemove', (e) => {
  if (!isDragging) {
    return;
  }
  
  const deltaX = e.clientX - dragStartX;
  const deltaY = e.clientY - dragStartY;
  
  if (!hasMoved && (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5)) {
    hasMoved = true;
    log('ğŸ–±ï¸ å¼€å§‹çœŸæ­£æ‹–åŠ¨');
  }
  
  if (hasMoved) {
    let newLeft = widgetStartX + deltaX;
    let newTop = widgetStartY + deltaY;
    
    const maxX = window.innerWidth - audioWidget.offsetWidth;
    const maxY = window.innerHeight - audioWidget.offsetHeight;
    
    newLeft = Math.max(0, Math.min(newLeft, maxX));
    newTop = Math.max(0, Math.min(newTop, maxY));
    
    audioWidget.style.left = newLeft + 'px';
    audioWidget.style.top = newTop + 'px';
    audioWidget.style.right = 'auto';
    audioWidget.style.bottom = 'auto';
  }
});

document.addEventListener('mouseup', (e) => {
  if (!isDragging) {
    return;
  }
  
  isDragging = false;
  audioWidget.classList.remove('dragging');
  
  if (hasMoved && !isMobile) {
    const position = {
      left: audioWidget.style.left,
      top: audioWidget.style.top
    };
    localStorage.setItem(STORAGE_KEY_POSITION, JSON.stringify(position));
    log(`ğŸ’¾ ä¿å­˜ä½ç½®: ${position.left}, ${position.top}`);
  } else {
    log('ğŸ–±ï¸ æœªç§»åŠ¨ï¼Œå–æ¶ˆæ‹–åŠ¨');
  }
  
  hasMoved = false;
});

document.addEventListener('mouseleave', () => {
  if (isDragging) {
    isDragging = false;
    hasMoved = false;
    audioWidget.classList.remove('dragging');
    log('ğŸ–±ï¸ é¼ æ ‡ç¦»å¼€çª—å£ï¼Œå¼ºåˆ¶å–æ¶ˆæ‹–åŠ¨');
  }
});

// ğŸ†• ç§»åŠ¨ç«¯ï¼šè§¦æ‘¸æ‹–åŠ¨
audioHeader.addEventListener('touchstart', (e) => {
  if (e.target.closest('#audioToggle')) return;
  
  const touch = e.touches[0];
  isDragging = true;
  hasMoved = false;
  
  dragStartX = touch.clientX;
  dragStartY = touch.clientY;
  
  const rect = audioWidget.getBoundingClientRect();
  widgetStartX = rect.left;
  widgetStartY = rect.top;
  
  audioWidget.classList.add('dragging');
  
  // ğŸ†• é•¿æŒ‰2ç§’é‡ç½®ä½ç½®
  longPressTimer = setTimeout(() => {
    if (!hasMoved) {
      resetPosition();
      isDragging = false;
      audioWidget.classList.remove('dragging');
      
      // éœ‡åŠ¨åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
      
      log('ğŸ“± é•¿æŒ‰é‡ç½®ä½ç½®');
    }
  }, 2000);
  
  log('ğŸ“± touchstart - è§¦æ‘¸æ‹–åŠ¨å¼€å§‹');
}, { passive: false });

document.addEventListener('touchmove', (e) => {
  if (!isDragging) return;
  
  const touch = e.touches[0];
  const deltaX = touch.clientX - dragStartX;
  const deltaY = touch.clientY - dragStartY;
  
  if (!hasMoved && (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5)) {
    hasMoved = true;
    clearTimeout(longPressTimer);
    log('ğŸ“± å¼€å§‹ç§»åŠ¨ï¼Œå–æ¶ˆé•¿æŒ‰');
  }
  
  if (hasMoved) {
    let newLeft = widgetStartX + deltaX;
    let newTop = widgetStartY + deltaY;
    
    const maxX = window.innerWidth - audioWidget.offsetWidth;
    const maxY = window.innerHeight - audioWidget.offsetHeight;
    
    newLeft = Math.max(0, Math.min(newLeft, maxX));
    newTop = Math.max(0, Math.min(newTop, maxY));
    
    audioWidget.style.left = newLeft + 'px';
    audioWidget.style.top = newTop + 'px';
    audioWidget.style.right = 'auto';
    audioWidget.style.bottom = 'auto';
    
    e.preventDefault();
  }
}, { passive: false });

document.addEventListener('touchend', () => {
  if (!isDragging) return;
  
  clearTimeout(longPressTimer);
  
  isDragging = false;
  audioWidget.classList.remove('dragging');
  
  if (hasMoved && !isMobile) {
    const position = {
      left: audioWidget.style.left,
      top: audioWidget.style.top
    };
    localStorage.setItem(STORAGE_KEY_POSITION, JSON.stringify(position));
    log('ğŸ“± è§¦æ‘¸æ‹–åŠ¨ç»“æŸï¼Œä¿å­˜ä½ç½®');
  }
  
  hasMoved = false;
});

document.addEventListener('touchcancel', () => {
  if (isDragging) {
    clearTimeout(longPressTimer);
    isDragging = false;
    hasMoved = false;
    audioWidget.classList.remove('dragging');
    log('ğŸ“± è§¦æ‘¸å–æ¶ˆ');
  }
});

// ========== é‡ç½®ä½ç½®å‡½æ•° ==========
function resetPosition() {
  audioWidget.style.left = '';
  audioWidget.style.top = '';
  audioWidget.style.right = '';
  audioWidget.style.bottom = '';
  
  localStorage.removeItem(STORAGE_KEY_POSITION);
  
  log(isMobile ? 'ğŸ“± ä½ç½®å·²é‡ç½®åˆ°åº•éƒ¨' : 'ğŸ–±ï¸ ä½ç½®å·²é‡ç½®åˆ°å³ä¸Šè§’');
  
  // æ˜¾ç¤ºæç¤º
  const originalText = hintBubble.textContent;
  hintBubble.textContent = 'âœ“ ä½ç½®å·²é‡ç½®';
  hintBubble.classList.add('show');
  
  setTimeout(() => {
    hintBubble.textContent = originalText;
    hintBubble.classList.remove('show');
  }, 2000);
}

// ========== çª—å£å¤§å°è°ƒæ•´ ==========
window.addEventListener('resize', () => {
  const rect = audioWidget.getBoundingClientRect();
  
  if (rect.right > window.innerWidth || rect.bottom > window.innerHeight) {
    resetPosition();
    log('çª—å£è°ƒæ•´ï¼Œé‡ç½®ä½ç½®');
  }
});

// ========== å¿«æ·é”®ï¼ˆä»…æ¡Œé¢ç«¯ï¼‰ ==========
if (!isMobile) {
  document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + Space åˆ‡æ¢æŠ˜å 
    if ((e.ctrlKey || e.metaKey) && e.code === 'Space') {
      e.preventDefault();
      audioToggle.click();
      log('âŒ¨ï¸ å¿«æ·é”®åˆ‡æ¢æŠ˜å çŠ¶æ€');
    }
    
    // ESC å¿«é€ŸæŠ˜å 
    if (e.code === 'Escape' && !audioWidget.classList.contains('collapsed') && !modalOverlay.classList.contains('show')) {
      e.preventDefault();
      audioToggle.click();
      log('âŒ¨ï¸ ESC å¿«é€ŸæŠ˜å ');
    }
    
    // Ctrl+Shift+D åˆ‡æ¢è°ƒè¯•æ¨¡å¼
    if (e.ctrlKey && e.shiftKey && e.key === 'D') {
      e.preventDefault();
      debugEnabled = !debugEnabled;
      debugPanel.classList.toggle('show', debugEnabled);
      log(`ğŸ› è°ƒè¯•æ¨¡å¼: ${debugEnabled ? 'å¼€å¯' : 'å…³é—­'}`);
    }
    
    // Ctrl+R åˆ·æ–°ä¸»ç”»é¢
    if (e.ctrlKey && e.key === 'r') {
      e.preventDefault();
      document.getElementById('refreshMain').click();
    }
    
    // Ctrl+Shift+R åˆ·æ–°è§£è¯´
    if (e.ctrlKey && e.shiftKey && e.key === 'R') {
      e.preventDefault();
      document.getElementById('refreshAudio').click();
    }
  });
  
  // å³é”®é‡ç½®ä½ç½®
  audioWidget.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    resetPosition();
  });
}

// ========== ç›‘å¬æ¥è‡ª iframe çš„æ¶ˆæ¯ ==========
window.addEventListener('message', (event) => {
  if (!event.origin.includes('bilibili.com')) {
    return;
  }
  
  try {
    const data = event.data;
    
    if (data.type === 'video_muted' && data.source === 'main') {
      log('ğŸ“º ä¸»ç”»é¢ç¡®è®¤ï¼šå·²é™éŸ³');
    }
    
    if (data.type === 'video_muted' && data.source === 'audio') {
      if (data.muted) {
        log('âš ï¸ è§£è¯´æ’­æ”¾å™¨æ„å¤–é™éŸ³ï¼Œå°è¯•æ¢å¤');
        audioFrame.contentWindow.postMessage({
          type: 'unmute',
          muted: false
        }, '*');
            } else {
        log('ğŸ”Š è§£è¯´æ’­æ”¾å™¨ç¡®è®¤ï¼šæœ‰å£°éŸ³');
      }
    }
  } catch (e) {
    // å¿½ç•¥è§£æé”™è¯¯
  }
});

// ========== é¡µé¢åŠ è½½å®Œæˆ ==========
window.addEventListener('load', () => {
  // æ¢å¤ä¸Šæ¬¡çš„çŠ¶æ€
  restoreState();
  
  // å»¶è¿Ÿå†æ¬¡ç¡®ä¿éŸ³é¢‘æœ‰å£°éŸ³
  setTimeout(() => {
    try {
      audioFrame.contentWindow.postMessage({
        type: 'unmute',
        muted: false,
        volume: 1.0
      }, '*');
      log('ğŸ”Š é¡µé¢åŠ è½½å®Œæˆåå†æ¬¡ç¡®ä¿è§£è¯´æœ‰å£°éŸ³');
    } catch (e) {
      log('âš ï¸ æ— æ³•å‘é€éŸ³é¢‘æ§åˆ¶æ¶ˆæ¯');
    }
  }, 2000);
  
  log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ');
  log('ğŸ“º å®˜æ–¹ç”»é¢ï¼šé™éŸ³æ¨¡å¼');
  log('ğŸ™ï¸ ç‚«ç¥è§£è¯´ï¼šæœ‰å£°éŸ³ï¼ˆå·²å¼ºåˆ¶å–æ¶ˆé™éŸ³ï¼‰');
  log(`ğŸ“ é»˜è®¤ä½ç½®ï¼š${isMobile ? 'å±å¹•åº•éƒ¨' : 'å±å¹•å³ä¸Šè§’ï¼Œheaderä¸‹æ–¹'}`);
  log('');
  
  if (!isMobile) {
    log('ğŸ® å¿«æ·é”®æç¤º:');
    log('  â€¢ Ctrl/Cmd + Space: åˆ‡æ¢æŠ˜å /å±•å¼€');
    log('  â€¢ ESC: å¿«é€ŸæŠ˜å ');
    log('  â€¢ Ctrl + R: åˆ·æ–°ä¸»ç”»é¢');
    log('  â€¢ Ctrl + Shift + R: åˆ·æ–°è§£è¯´ç”»é¢');
    log('  â€¢ å³é”®æ’­æ”¾å™¨: é‡ç½®ä½ç½®');
    log('  â€¢ Ctrl+Shift+D: å¼€å¯/å…³é—­è°ƒè¯•æ—¥å¿—');
  } else {
    log('ğŸ“± ç§»åŠ¨ç«¯æç¤º:');
    log('  â€¢ ç‚¹å‡» â–² æŒ‰é’®ï¼šå±•å¼€/æŠ˜å æ’­æ”¾å™¨');
    log('  â€¢ æ‹–åŠ¨æ ‡é¢˜æ ï¼šç§»åŠ¨çª—å£ä½ç½®');
    log('  â€¢ é•¿æŒ‰æ ‡é¢˜æ 2ç§’ï¼šé‡ç½®åˆ°é»˜è®¤ä½ç½®');
    log('  â€¢ ç‚¹å‡»ä½¿ç”¨è¯´æ˜ï¼šæŸ¥çœ‹è¯¦ç»†æ“ä½œæŒ‡å—');
  }
});

// ========== é¡µé¢å¯è§æ€§æ£€æµ‹ ==========
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    log('âš ï¸ é¡µé¢åˆ‡æ¢åˆ°åå°');
  } else {
    log('âœ“ é¡µé¢åˆ‡æ¢åˆ°å‰å°');
    
    // é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œå†æ¬¡ç¡®ä¿éŸ³é¢‘æœ‰å£°éŸ³
    setTimeout(() => {
      try {
        audioFrame.contentWindow.postMessage({
          type: 'unmute',
          muted: false
        }, '*');
        log('ğŸ”Š é¡µé¢æ¢å¤å¯è§ï¼Œé‡æ–°ç¡®ä¿è§£è¯´æœ‰å£°éŸ³');
      } catch (e) {
        log('âš ï¸ æ— æ³•é‡æ–°æ§åˆ¶éŸ³é¢‘');
      }
    }, 500);
  }
});

// ========== è¶…æ—¶æ£€æµ‹ ==========
let loadTimer = setTimeout(() => {
  if (!videoLoaded || !audioLoaded) {
    log('âš ï¸ éƒ¨åˆ†ç›´æ’­æµåŠ è½½è¶…æ—¶');
    statusDot.className = 'dot error';
    statusText.textContent = 'è¿æ¥è¶…æ—¶';
  }
}, 15000);

// æ¸…é™¤è¶…æ—¶æ£€æµ‹
if (videoLoaded && audioLoaded) {
  clearTimeout(loadTimer);
}

// ========== å®šæœŸæ£€æŸ¥éŸ³é¢‘çŠ¶æ€ ==========
setInterval(() => {
  if (audioLoaded) {
    try {
      // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œç¡®ä¿è§£è¯´æœ‰å£°éŸ³
      audioFrame.contentWindow.postMessage({
        type: 'check_muted'
      }, '*');
    } catch (e) {
      // å¿½ç•¥é”™è¯¯
    }
  }
}, 30000);

// ========== é˜²æ­¢æ‹–åŠ¨æ—¶çš„æ„å¤–è¡Œä¸º ==========
audioWidget.addEventListener('mouseenter', () => {
  if (!isDragging) {
    audioWidget.classList.remove('dragging');
  }
});

audioWidget.addEventListener('mouseleave', () => {
  if (!isDragging) {
    audioWidget.classList.remove('dragging');
  }
});

// ========== å…¨å±€é¼ æ ‡æŒ‰é”®çŠ¶æ€ç›‘å¬ ==========
document.addEventListener('mousedown', (e) => {
  if (!audioHeader.contains(e.target)) {
    isDragging = false;
    hasMoved = false;
    audioWidget.classList.remove('dragging');
  }
});

// ========== ğŸ†• ç§»åŠ¨ç«¯ç‰¹æ®Šå¤„ç† ==========
if (isMobile) {
  // ç¦æ­¢é¡µé¢æ»šåŠ¨
  document.body.style.overflow = 'hidden';
  document.documentElement.style.overflow = 'hidden';
  
  // ç¦æ­¢åŒå‡»ç¼©æ”¾
  let lastTouchEnd = 0;
  document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, { passive: false });
  
  // ğŸ†• iOS Safari åœ°å€æ éšè—å¤„ç†
  if (isIOS) {
    // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½åè°ƒæ•´è§†å£
    window.addEventListener('load', () => {
      setTimeout(() => {
        window.scrollTo(0, 1);
        log('ğŸ“± iOS: éšè—åœ°å€æ ');
      }, 100);
    });
    
    // ç›‘å¬å±å¹•æ–¹å‘å˜åŒ–
    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        window.scrollTo(0, 1);
        log('ğŸ“± iOS: å±å¹•æ—‹è½¬ï¼Œé‡æ–°è°ƒæ•´');
      }, 100);
    });
  }
  
  // ğŸ†• é˜»æ­¢æ©¡çš®ç­‹æ•ˆæœï¼ˆiOSï¼‰
  let startY = 0;
  document.addEventListener('touchstart', (e) => {
    startY = e.touches[0].pageY;
  }, { passive: true });
  
  document.addEventListener('touchmove', (e) => {
    const y = e.touches[0].pageY;
    const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
    
    // åœ¨é¡¶éƒ¨ä¸‹æ‹‰æˆ–åœ¨åº•éƒ¨ä¸Šæ‹‰æ—¶é˜»æ­¢é»˜è®¤è¡Œä¸º
    if ((scrollTop <= 0 && y > startY) || 
        (scrollTop + window.innerHeight >= document.documentElement.scrollHeight && y < startY)) {
      if (!audioHeader.contains(e.target)) {
        e.preventDefault();
      }
    }
  }, { passive: false });
  
  log('ğŸ“± ç§»åŠ¨ç«¯ä¼˜åŒ–å·²å¯ç”¨');
}

// ========== ğŸ†• ç½‘ç»œçŠ¶æ€ç›‘å¬ ==========
window.addEventListener('online', () => {
  log('âœ… ç½‘ç»œå·²è¿æ¥');
  statusDot.className = 'dot success';
  statusText.textContent = 'æ’­æ”¾ä¸­';
});

window.addEventListener('offline', () => {
  log('âŒ ç½‘ç»œå·²æ–­å¼€');
  statusDot.className = 'dot error';
  statusText.textContent = 'ç½‘ç»œæ–­å¼€';
});

// ========== ğŸ†• ç”µæ± çŠ¶æ€ç›‘å¬ï¼ˆç§»åŠ¨ç«¯ï¼‰ ==========
if (isMobile && 'getBattery' in navigator) {
  navigator.getBattery().then((battery) => {
    const logBatteryStatus = () => {
      log(`ğŸ”‹ ç”µé‡: ${Math.round(battery.level * 100)}%, å……ç”µä¸­: ${battery.charging}`);
    };
    
    battery.addEventListener('levelchange', logBatteryStatus);
    battery.addEventListener('chargingchange', logBatteryStatus);
  }).catch((e) => {
    log('âš ï¸ æ— æ³•è·å–ç”µæ± çŠ¶æ€');
  });
}

// ========== ğŸ†• æ€§èƒ½ç›‘æ§ ==========
if ('PerformanceObserver' in window) {
  try {
    const observer = new PerformanceObserver((list) => {
      for (const entry of list.getEntries()) {
        if (entry.entryType === 'navigation') {
          log(`â±ï¸ é¡µé¢åŠ è½½æ—¶é—´: ${Math.round(entry.loadEventEnd - entry.fetchStart)}ms`);
        }
      }
    });
    observer.observe({ entryTypes: ['navigation'] });
  } catch (e) {
    // å¿½ç•¥ä¸æ”¯æŒçš„æµè§ˆå™¨
  }
}

// ========== ğŸ†• å†…å­˜è­¦å‘Šï¼ˆç§»åŠ¨ç«¯ï¼‰ ==========
if (isMobile && 'memory' in performance) {
  setInterval(() => {
    const memory = performance.memory;
    const usedPercent = (memory.usedJSHeapSize / memory.jsHeapSizeLimit) * 100;
    
    if (usedPercent > 90) {
      log(`âš ï¸ å†…å­˜ä½¿ç”¨è¿‡é«˜: ${Math.round(usedPercent)}%`);
    }
  }, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
}

// ========== ğŸ†• å…¨å±æ”¯æŒ ==========
if (isMobile) {
  let isFullscreen = false;
  
  const toggleFullscreen = () => {
    if (!isFullscreen) {
      if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen();
      } else if (document.documentElement.webkitRequestFullscreen) {
        document.documentElement.webkitRequestFullscreen();
      }
      log('ğŸ“± è¿›å…¥å…¨å±æ¨¡å¼');
    } else {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      }
      log('ğŸ“± é€€å‡ºå…¨å±æ¨¡å¼');
    }
  };
  
  document.addEventListener('fullscreenchange', () => {
    isFullscreen = !!document.fullscreenElement;
  });
  
  document.addEventListener('webkitfullscreenchange', () => {
    isFullscreen = !!document.webkitFullscreenElement;
  });
  
  // åŒå‡»è§†é¢‘åŒºåŸŸå…¨å±ï¼ˆç§»åŠ¨ç«¯ï¼‰
  const box = document.querySelector('.box');
  let lastTap = 0;
  box.addEventListener('touchend', (e) => {
    const currentTime = new Date().getTime();
    const tapLength = currentTime - lastTap;
    
    if (tapLength < 300 && tapLength > 0) {
      toggleFullscreen();
      e.preventDefault();
    }
    lastTap = currentTime;
  });
}

// ========== ğŸ†• é˜»æ­¢é•¿æŒ‰èœå•ï¼ˆç§»åŠ¨ç«¯ï¼‰ ==========
if (isMobile) {
  document.addEventListener('contextmenu', (e) => {
    e.preventDefault();
  }, { passive: false });
  
  // é˜»æ­¢å›¾ç‰‡å’Œé“¾æ¥çš„é•¿æŒ‰ä¿å­˜
  document.addEventListener('touchstart', (e) => {
    if (e.target.tagName === 'IMG' || e.target.tagName === 'A') {
      e.preventDefault();
    }
  }, { passive: false });
}

// ========== ğŸ†• å”¤é†’é”ï¼ˆé˜²æ­¢å±å¹•ä¼‘çœ ï¼‰ ==========
if ('wakeLock' in navigator && isMobile) {
  let wakeLock = null;
  
  const requestWakeLock = async () => {
    try {
      wakeLock = await navigator.wakeLock.request('screen');
      log('ğŸ”’ å±å¹•ä¿æŒå”¤é†’');
      
      wakeLock.addEventListener('release', () => {
        log('ğŸ”“ å±å¹•å”¤é†’å·²é‡Šæ”¾');
      });
    } catch (err) {
      log(`âš ï¸ æ— æ³•å¯ç”¨å±å¹•å”¤é†’: ${err.message}`);
    }
  };
  
  // é¡µé¢å¯è§æ—¶è¯·æ±‚å”¤é†’é”
  document.addEventListener('visibilitychange', async () => {
    if (!document.hidden && wakeLock === null) {
      await requestWakeLock();
    }
  });
  
  // åˆå§‹è¯·æ±‚
  requestWakeLock();
}

// ========== ğŸ†• PWA å®‰è£…æç¤º ==========
if (isMobile) {
  let deferredPrompt = null;
  
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    log('ğŸ“² PWA å¯å®‰è£…');
    
    // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºè‡ªå®šä¹‰çš„å®‰è£…æç¤º
    // æš‚æ—¶æ³¨é‡Šæ‰ï¼Œé¿å…æ‰“æ‰°ç”¨æˆ·
    /*
    setTimeout(() => {
      if (confirm('æ˜¯å¦å°†æ­¤é¡µé¢æ·»åŠ åˆ°ä¸»å±å¹•ï¼Ÿ')) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            log('ğŸ“² ç”¨æˆ·æ¥å—å®‰è£…');
          } else {
            log('ğŸ“² ç”¨æˆ·æ‹’ç»å®‰è£…');
          }
          deferredPrompt = null;
        });
      }
    }, 5000);
    */
  });
  
  window.addEventListener('appinstalled', () => {
    log('ğŸ“² PWA å·²å®‰è£…');
    deferredPrompt = null;
  });
}

log('ğŸ¬ è„šæœ¬åˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…ç›´æ’­æµåŠ è½½...');
</script>
</body>
</html>
