<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>S15 åŸç”» + ç‚«ç¥è§£è¯´</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  /* ========== Microsoft Fluent é£æ ¼è®¾è®¡ ========== */
  *{margin:0;padding:0;box-sizing:border-box}
  
  html, body{
    width:100%;
    height:100%;
    overflow:hidden;
    position:fixed;
    -webkit-overflow-scrolling:touch;
  }
  
  body{
    font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
    background:#000;
    color:#fff;
    display:flex;
    flex-direction:column;
    padding-top:env(safe-area-inset-top);
    padding-bottom:env(safe-area-inset-bottom);
    padding-left:env(safe-area-inset-left);
    padding-right:env(safe-area-inset-right);
  }
  
  /* ========== é¡¶éƒ¨å·¥å…·æ  ========== */
  header{
    background:#1f1f1f;
    border-bottom:1px solid #333;
    padding:0;
    display:flex;
    align-items:stretch;
    z-index:10;
    flex-shrink:0;
    height:48px;
  }
  
  /* å·¦ä¾§çŠ¶æ€åŒº */
  .header-left{
    display:flex;
    align-items:center;
    padding:0 16px;
    gap:12px;
    border-right:1px solid #333;
  }
  
  .status-badge{
    background:#c50f1f;
    color:#fff;
    padding:4px 10px;
    font-weight:600;
    font-size:11px;
    letter-spacing:0.5px;
    text-transform:uppercase;
  }
  
  .title-text{
    font-size:13px;
    font-weight:400;
    color:#e0e0e0;
    white-space:nowrap;
  }
  
  /* ä¸­é—´æ§åˆ¶åŒº */
  .header-center{
    display:flex;
    align-items:center;
    gap:0;
    flex:1;
    overflow-x:auto;
    overflow-y:hidden;
  }
  
  .header-center::-webkit-scrollbar{
    height:0;
  }
  
  /* å³ä¾§çŠ¶æ€åŒº */
  .header-right{
    display:flex;
    align-items:center;
    padding:0 16px;
    gap:8px;
    border-left:1px solid #333;
  }
  
  .status-indicator{
    display:flex;
    align-items:center;
    gap:8px;
    font-size:12px;
    color:#b0b0b0;
  }
  
  .status-dot{
    width:8px;
    height:8px;
    border-radius:50%;
    background:#6c6c6c;
  }
  .status-dot.loading{background:#f7b731;animation:pulse 1.5s infinite}
  .status-dot.success{background:#10b981}
  .status-dot.error{background:#c50f1f;animation:blink 1s infinite}
  
  @keyframes pulse{
    0%,100%{opacity:.5}
    50%{opacity:1}
  }
  @keyframes blink{
    0%,100%{opacity:1}
    50%{opacity:.3}
  }
  
  /* ========== å·¥å…·æ æŒ‰é’® ========== */
  .toolbar-btn{
    height:48px;
    padding:0 16px;
    background:transparent;
    border:none;
    border-right:1px solid #333;
    color:#e0e0e0;
    font-size:13px;
    font-family:'Segoe UI',sans-serif;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:8px;
    transition:background .15s ease;
    white-space:nowrap;
    -webkit-tap-highlight-color:transparent;
  }
  
  .toolbar-btn:hover{
    background:#2d2d2d;
  }
  
  .toolbar-btn:active{
    background:#3d3d3d;
  }
  
  .toolbar-btn.primary{
    background:#0078d4;
    color:#fff;
    border-right:1px solid #005a9e;
  }
  
  .toolbar-btn.primary:hover{
    background:#106ebe;
  }
  
  .toolbar-btn.primary:active{
    background:#005a9e;
  }
  
  .toolbar-btn .icon{
    font-size:16px;
    font-weight:400;
  }
  
  /* ========== ä¸»è§†é¢‘åŒºåŸŸ ========== */
  .box{
    flex:1;
    display:flex;
    position:relative;
    overflow:hidden;
    min-height:0;
    background:#000;
  }
  
  iframe{
    width:100%;
    height:100%;
    border:0;
  }
  
  /* ========== ç‚«ç¥è§£è¯´æŠ˜å é¢æ¿ ========== */
  .audio-panel{
    position:absolute;
    top:0;
    right:0;
    background:#1f1f1f;
    border-left:1px solid #333;
    border-bottom:1px solid #333;
    z-index:100;
    display:flex;
    flex-direction:column;
    transition:width .2s ease, height .2s ease;
    box-shadow:-2px 2px 8px rgba(0,0,0,.5);
  }
  
  .audio-panel.collapsed{
    width:200px;
    height:48px;
  }
  
  .audio-panel.expanded{
    width:400px;
    height:300px;
  }
  
  /* é¢æ¿æ ‡é¢˜æ  */
  .panel-header{
    height:48px;
    background:#2d2d2d;
    border-bottom:1px solid #333;
    display:flex;
    align-items:center;
    padding:0 16px;
    cursor:pointer;
    user-select:none;
  }
  
  .panel-header:hover{
    background:#3d3d3d;
  }
  
  .panel-title{
    flex:1;
    font-size:13px;
    font-weight:600;
    color:#e0e0e0;
  }
  
  .panel-toggle{
    width:32px;
    height:32px;
    background:transparent;
    border:1px solid #555;
    color:#e0e0e0;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    transition:all .15s ease;
  }
  
  .panel-toggle:hover{
    background:#3d3d3d;
    border-color:#666;
  }
  
  .audio-panel.collapsed .panel-toggle{
    transform:rotate(180deg);
  }
  
  /* é¢æ¿å†…å®¹ */
  .panel-content{
    flex:1;
    display:flex;
    flex-direction:column;
    overflow:hidden;
    opacity:1;
    transition:opacity .2s ease;
  }
  
  .audio-panel.collapsed .panel-content{
    opacity:0;
    pointer-events:none;
  }
  
  .panel-player{
    flex:1;
    background:#000;
    border-bottom:1px solid #333;
  }
  
  .panel-controls{
    height:48px;
    display:flex;
    padding:8px;
    gap:8px;
    background:#1f1f1f;
  }
  
  .panel-btn{
    flex:1;
    height:32px;
    background:#0078d4;
    border:1px solid #005a9e;
    color:#fff;
    font-size:12px;
    font-family:'Segoe UI',sans-serif;
    cursor:pointer;
    transition:background .15s ease;
    -webkit-tap-highlight-color:transparent;
  }
  
  .panel-btn:hover{
    background:#106ebe;
  }
  
  .panel-btn:active{
    background:#005a9e;
  }
  
  /* ========== æ¨¡æ€å¼¹çª—ï¼ˆMicrosoft é£æ ¼ï¼‰ ========== */
  .modal-overlay{
    position:fixed;
    top:0;
    left:0;
    right:0;
    bottom:0;
    background:rgba(0,0,0,.6);
    z-index:9999;
    display:none;
    align-items:center;
    justify-content:center;
    padding:20px;
  }
  
  .modal-overlay.show{
    display:flex;
  }
  
  .modal{
    background:#1f1f1f;
    border:1px solid #333;
    max-width:600px;
    width:100%;
    max-height:80vh;
    display:flex;
    flex-direction:column;
    box-shadow:0 8px 32px rgba(0,0,0,.8);
  }
  
  .modal-header{
    height:48px;
    padding:0 16px;
    background:#2d2d2d;
    border-bottom:1px solid #333;
    display:flex;
    align-items:center;
    justify-content:space-between;
  }
  
  .modal-title{
    font-size:14px;
    font-weight:600;
    color:#fff;
  }
  
  .modal-close{
    width:32px;
    height:32px;
    background:transparent;
    border:1px solid #555;
    color:#e0e0e0;
    font-size:16px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:all .15s ease;
    -webkit-tap-highlight-color:transparent;
  }
  
  .modal-close:hover{
    background:#3d3d3d;
    border-color:#666;
  }
  
  .modal-body{
    flex:1;
    overflow-y:auto;
    padding:24px;
    color:#e0e0e0;
    line-height:1.6;
  }
  
  .modal-body::-webkit-scrollbar{
    width:12px;
  }
  
  .modal-body::-webkit-scrollbar-track{
    background:#1f1f1f;
  }
  
  .modal-body::-webkit-scrollbar-thumb{
    background:#555;
    border:2px solid #1f1f1f;
  }
  
  .modal-body::-webkit-scrollbar-thumb:hover{
    background:#666;
  }
  
  /* æ­¥éª¤åˆ—è¡¨ */
  .step{
    margin-bottom:24px;
    padding:16px;
    background:#2d2d2d;
    border-left:3px solid #0078d4;
  }
  
  .step-header{
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom:12px;
  }
  
  .step-number{
    width:28px;
    height:28px;
    background:#0078d4;
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:600;
    font-size:14px;
  }
  
  .step-title{
    font-weight:600;
    color:#fff;
    font-size:14px;
  }
  
  .step-desc{
    font-size:13px;
    color:#b0b0b0;
    line-height:1.7;
  }
  
  .step-desc strong{
    color:#e0e0e0;
  }
  
  /* æç¤ºæ¡† */
  .info-box{
    background:#2d2d2d;
    border:1px solid #555;
    padding:16px;
    margin-top:24px;
  }
  
  .info-box.warning{
    border-left:3px solid #f7b731;
  }
  
  .info-box.error{
    border-left:3px solid #c50f1f;
  }
  
  .info-title{
    font-weight:600;
    color:#fff;
    margin-bottom:12px;
    font-size:14px;
  }
  
  .info-list{
    font-size:13px;
    color:#b0b0b0;
    line-height:1.8;
    list-style:none;
    padding-left:0;
  }
  
  .info-list li{
    padding-left:20px;
    position:relative;
  }
  
  .info-list li:before{
    content:'â–ª';
    position:absolute;
    left:0;
    color:#0078d4;
  }
  
  .kbd{
    display:inline-block;
    padding:2px 6px;
    background:#3d3d3d;
    border:1px solid #555;
    font-size:11px;
    font-family:'Consolas','Courier New',monospace;
    color:#e0e0e0;
  }
  
  /* è°ƒè¯•æ—¥å¿— */
  .debug{
    position:fixed;
    top:60px;
    left:16px;
    background:#1f1f1f;
    border:1px solid #333;
    padding:12px;
    font-size:11px;
    font-family:'Consolas','Courier New',monospace;
    max-width:400px;
    max-height:300px;
    overflow-y:auto;
    color:#10b981;
    display:none;
    z-index:999;
  }
  .debug.show{display:block}
  .debug div{margin:2px 0}
  
  /* ========== ç§»åŠ¨ç«¯é€‚é… ========== */
  @media (max-width: 768px) {
    header{
      height:auto;
      flex-wrap:wrap;
    }
    
    .header-left{
      padding:8px 12px;
      height:44px;
    }
    
    .status-badge{
      font-size:10px;
      padding:3px 8px;
    }
    
    .title-text{
      font-size:12px;
    }
    
    .header-center{
      width:100%;
      border-top:1px solid #333;
      height:44px;
    }
    
    .toolbar-btn{
      height:44px;
      padding:0 12px;
      font-size:12px;
    }
    
    .header-right{
      display:none; /* ç§»åŠ¨ç«¯éšè—çŠ¶æ€æŒ‡ç¤ºå™¨ */
    }
    
    /* ç‚«ç¥è§£è¯´é¢æ¿åœ¨ç§»åŠ¨ç«¯å›ºå®šåº•éƒ¨ */
    .audio-panel{
      position:fixed;
      top:auto;
      bottom:0;
      left:0;
      right:0;
      border:none;
      border-top:1px solid #333;
    }
    
    .audio-panel.collapsed{
      width:100%;
      height:44px;
    }
    
    .audio-panel.expanded{
      width:100%;
      height:60vh;
      max-height:400px;
    }
    
    .panel-header{
      height:44px;
    }
    
    .modal{
      max-width:calc(100vw - 20px);
    }
    
    .modal-body{
      padding:16px;
    }
    
    .step{
      padding:12px;
      margin-bottom:16px;
    }
    
    .debug{
      display:none !important;
    }
    
    /* ğŸ†• ç¡®ä¿æ’­æ”¾å™¨æ§åˆ¶æ å¯è§ */
    .box{
      padding-bottom:60px; /* ä¸ºç‚«ç¥é¢æ¿ç•™å‡ºç©ºé—´ */
    }
    
    .audio-panel.collapsed ~ .box{
      padding-bottom:44px;
    }
  }
  
  /* æ¨ªå±æ¨¡å¼ */
  @media (max-width: 768px) and (orientation: landscape) {
    .audio-panel.expanded{
      height:80vh;
    }
  }
</style>
</head>
<body>

<!-- ========== é¡¶éƒ¨å·¥å…·æ  ========== -->
<header>
  <div class="header-left">
    <span class="status-badge">LIVE</span>
    <span class="title-text">S15 å®˜æ–¹ç”»é¢ + Lastç‚«ç¥è§£è¯´</span>
  </div>
  
  <div class="header-center">
    <button class="toolbar-btn" id="toggleAudioBtn">
      <span class="icon">â–²</span>
      <span>ç‚«ç¥è§£è¯´</span>
    </button>
    
    <button class="toolbar-btn" id="refreshAudioBtn">
      <span class="icon">âŸ³</span>
      <span>åˆ·æ–°è§£è¯´</span>
    </button>
    
    <button class="toolbar-btn" id="refreshMainBtn">
      <span class="icon">âŸ³</span>
      <span>åˆ·æ–°ä¸»ç”»é¢</span>
    </button>
    
    <button class="toolbar-btn" id="helpBtn">
      <span class="icon">?</span>
      <span>ä½¿ç”¨è¯´æ˜</span>
    </button>
  </div>
  
  <div class="header-right">
    <div class="status-indicator">
      <span class="status-dot success" id="statusDot"></span>
      <span id="statusText">æ’­æ”¾ä¸­</span>
    </div>
  </div>
</header>

<!-- ========== ä¸»è§†é¢‘åŒºåŸŸ ========== -->
<section class="box">
  <!-- å®˜æ–¹ç”»é¢ï¼ˆé™éŸ³ï¼‰ -->
  <iframe id="videoFrame"
          src="https://www.bilibili.com/blackboard/live/live-activity-player.html?cid=7734200&quality=1&muted=1"
          sandbox="allow-scripts allow-same-origin allow-presentation"
          allow="autoplay *; encrypted-media *; fullscreen *"
          referrerpolicy="no-referrer">
  </iframe>
  
  <!-- ========== ç‚«ç¥è§£è¯´æŠ˜å é¢æ¿ ========== -->
  <div class="audio-panel collapsed" id="audioPanel">
    <div class="panel-header" id="panelHeader">
      <div class="panel-title">ç‚«ç¥è§£è¯´ç›´æ’­é—´</div>
      <button class="panel-toggle" id="panelToggle">â–²</button>
    </div>
    
    <div class="panel-content">
      <div class="panel-player">
        <iframe id="audioFrame"
                src="https://www.bilibili.com/blackboard/live/live-activity-player.html?cid=84074&quality=1"
                sandbox="allow-scripts allow-same-origin allow-presentation"
                allow="autoplay *; encrypted-media *"
                referrerpolicy="no-referrer"
                style="width:100%;height:100%;border:0">
        </iframe>
      </div>
      
      <div class="panel-controls">
        <button class="panel-btn" id="refreshAudioBtn2">åˆ·æ–°è§£è¯´</button>
      </div>
    </div>
  </div>
</section>

<!-- ========== ä½¿ç”¨è¯´æ˜å¼¹çª— ========== -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">ä½¿ç”¨è¯´æ˜</div>
      <button class="modal-close" id="modalClose">Ã—</button>
    </div>
    
    <div class="modal-body">
      <div class="step">
        <div class="step-header">
          <div class="step-number">1</div>
          <div class="step-title">è§‚çœ‹åŒè§†è§’ç›´æ’­</div>
        </div>
        <div class="step-desc">
          å¤§å±å¹•æ˜¾ç¤ºå®˜æ–¹ç”»é¢ï¼ˆæ— å£°éŸ³ï¼‰ï¼Œå³ä¸Šè§’å°çª—å£æ’­æ”¾ç‚«ç¥è§£è¯´ï¼ˆæœ‰å£°éŸ³ï¼‰ã€‚<br>
          <strong>å»ºè®®ï¼šè¿›å…¥åç›´æ¥ç‚¹å‡»å³ä¸‹è§’å…¨å±æŒ‰é’®è§‚èµï¼Œä½“éªŒæœ€ä½³ã€‚</strong>
        </div>
      </div>
      
      <div class="step">
        <div class="step-header">
          <div class="step-number">2</div>
          <div class="step-title">å±•å¼€/æŠ˜å è§£è¯´çª—å£</div>
        </div>
        <div class="step-desc">
          ç‚¹å‡»é¡¶éƒ¨å·¥å…·æ çš„ <strong>"ç‚«ç¥è§£è¯´"</strong> æŒ‰é’®ï¼Œæˆ–ç‚¹å‡»å³ä¸Šè§’è§£è¯´çª—å£çš„ <strong>â–²</strong> æŒ‰é’®ï¼Œå¯ä»¥å±•å¼€æˆ–æŠ˜å è§£è¯´æ’­æ”¾å™¨ã€‚
        </div>
      </div>
      
      <div class="step">
        <div class="step-header">
          <div class="step-number">3</div>
          <div class="step-title">åˆ·æ–°æ’­æ”¾å™¨</div>
        </div>
        <div class="step-desc">
          â€¢ å¦‚æœä¸»ç”»é¢å¡é¡¿æˆ–é»‘å±ï¼Œç‚¹å‡»é¡¶éƒ¨ <strong>"åˆ·æ–°ä¸»ç”»é¢"</strong> æŒ‰é’®<br>
          â€¢ å¦‚æœè§£è¯´æ— å£°éŸ³æˆ–å¡é¡¿ï¼Œç‚¹å‡»é¡¶éƒ¨ <strong>"åˆ·æ–°è§£è¯´"</strong> æŒ‰é’®
        </div>
      </div>
      
            <div class="step">
        <div class="step-header">
          <div class="step-number">4</div>
          <div class="step-title">å…¨å±è§‚çœ‹</div>
        </div>
        <div class="step-desc">
          <strong>ç”µè„‘ç«¯ï¼š</strong>ç‚¹å‡»æ’­æ”¾å™¨å³ä¸‹è§’çš„å…¨å±æŒ‰é’®<br>
          <strong>æ‰‹æœºç«¯ï¼š</strong>å»ºè®®æ¨ªå±è§‚çœ‹ï¼Œç«–å±æ—¶éœ€è¦å…ˆå±•å¼€è§£è¯´çª—å£æ‰èƒ½çœ‹åˆ°å…¨å±æŒ‰é’®
        </div>
      </div>
      
      <div class="step">
        <div class="step-header">
          <div class="step-number">5</div>
          <div class="step-title">å¿«æ·é”®ï¼ˆä»…ç”µè„‘ç«¯ï¼‰</div>
        </div>
        <div class="step-desc">
          <span class="kbd">Ctrl</span> + <span class="kbd">Space</span> åˆ‡æ¢è§£è¯´çª—å£<br>
          <span class="kbd">ESC</span> å¿«é€ŸæŠ˜å è§£è¯´çª—å£<br>
          <span class="kbd">Ctrl</span> + <span class="kbd">R</span> åˆ·æ–°ä¸»ç”»é¢<br>
          <span class="kbd">Ctrl</span> + <span class="kbd">Shift</span> + <span class="kbd">R</span> åˆ·æ–°è§£è¯´
        </div>
      </div>
      
      <div class="info-box warning">
        <div class="info-title">æ³¨æ„äº‹é¡¹</div>
        <ul class="info-list">
          <li>ä¸»ç”»é¢é»˜è®¤é™éŸ³ï¼Œå£°éŸ³æ¥è‡ªç‚«ç¥è§£è¯´çª—å£</li>
          <li>é¦–æ¬¡åŠ è½½å¯èƒ½éœ€è¦ç­‰å¾…å‡ ç§’é’Ÿ</li>
          <li>ç§»åŠ¨ç«¯å»ºè®®ä½¿ç”¨æ¨ªå±è§‚çœ‹ä»¥è·å¾—æœ€ä½³ä½“éªŒ</li>
          <li>å¦‚é‡åˆ°åŠ è½½é—®é¢˜ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢</li>
        </ul>
      </div>
      
      <div class="info-box error">
        <div class="info-title">å¸¸è§é—®é¢˜è§£å†³</div>
        <ul class="info-list">
          <li><strong>è§£è¯´æ²¡å£°éŸ³ï¼Ÿ</strong> ç‚¹å‡»"åˆ·æ–°è§£è¯´"æŒ‰é’®</li>
          <li><strong>ç”»é¢é»‘å±ï¼Ÿ</strong> ç‚¹å‡»"åˆ·æ–°ä¸»ç”»é¢"æŒ‰é’®</li>
          <li><strong>ç”»é¢å¡é¡¿ï¼Ÿ</strong> æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œå°è¯•åˆ·æ–°é¡µé¢</li>
          <li><strong>ç§»åŠ¨ç«¯æ§åˆ¶æ è¢«é®æŒ¡ï¼Ÿ</strong> æ¨ªå±è§‚çœ‹æˆ–æŠ˜å è§£è¯´çª—å£</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- è°ƒè¯•æ—¥å¿— -->
<div class="debug" id="debug"></div>

<script>
// ========== è°ƒè¯•æ—¥å¿—ç³»ç»Ÿ ==========
const debugPanel = document.getElementById('debug');
let debugEnabled = false;

function log(msg) {
  const now = new Date().toLocaleTimeString();
  console.log(`[${now}] ${msg}`);
  
  if (debugEnabled) {
    debugPanel.classList.add('show');
    const div = document.createElement('div');
    div.textContent = `${now} ${msg}`;
    debugPanel.appendChild(div);
    debugPanel.scrollTop = debugPanel.scrollHeight;
  }
}

log('é¡µé¢å¼€å§‹åŠ è½½');

// ========== æ£€æµ‹è®¾å¤‡ç±»å‹ ==========
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
log(`è®¾å¤‡ç±»å‹: ${isMobile ? 'ç§»åŠ¨ç«¯' : 'æ¡Œé¢ç«¯'}, iOS: ${isIOS}`);

// ========== DOM å…ƒç´  ==========
const videoFrame = document.getElementById('videoFrame');
const audioFrame = document.getElementById('audioFrame');
const audioPanel = document.getElementById('audioPanel');
const panelToggle = document.getElementById('panelToggle');
const panelHeader = document.getElementById('panelHeader');
const toggleAudioBtn = document.getElementById('toggleAudioBtn');
const refreshMainBtn = document.getElementById('refreshMainBtn');
const refreshAudioBtn = document.getElementById('refreshAudioBtn');
const refreshAudioBtn2 = document.getElementById('refreshAudioBtn2');
const helpBtn = document.getElementById('helpBtn');
const modalOverlay = document.getElementById('modalOverlay');
const modalClose = document.getElementById('modalClose');
const statusDot = document.getElementById('statusDot');
const statusText = document.getElementById('statusText');

// ========== åŠ è½½çŠ¶æ€ ==========
let videoLoaded = false;
let audioLoaded = false;

videoFrame.onload = () => {
  videoLoaded = true;
  log('å®˜æ–¹ç”»é¢åŠ è½½å®Œæˆï¼ˆé™éŸ³ï¼‰');
  checkBothLoaded();
};

audioFrame.onload = () => {
  audioLoaded = true;
  log('è§£è¯´éŸ³é¢‘åŠ è½½å®Œæˆ');
  
  // ç¡®ä¿éŸ³é¢‘æœ‰å£°éŸ³
  setTimeout(() => {
    try {
      audioFrame.contentWindow.postMessage({
        type: 'unmute',
        muted: false
      }, '*');
      log('å·²å‘é€å–æ¶ˆé™éŸ³æŒ‡ä»¤åˆ°è§£è¯´æ’­æ”¾å™¨');
    } catch (e) {
      log('æ— æ³•ç›´æ¥æ§åˆ¶éŸ³é¢‘: ' + e.message);
    }
  }, 1000);
  
  checkBothLoaded();
};

audioFrame.onerror = () => {
  log('éŸ³é¢‘åŠ è½½å¤±è´¥');
  if (statusDot) {
    statusDot.className = 'status-dot error';
  }
  if (statusText) {
    statusText.textContent = 'åŠ è½½å¤±è´¥';
  }
};

function checkBothLoaded() {
  if (videoLoaded && audioLoaded) {
    log('ä¸¤ä¸ªç›´æ’­æµéƒ½å·²åŠ è½½');
    
    setTimeout(() => {
      if (statusDot) {
        statusDot.className = 'status-dot success';
      }
      if (statusText) {
        statusText.textContent = 'æ’­æ”¾ä¸­';
      }
      log('ç›´æ’­æ’­æ”¾ä¸­ï¼ˆå®˜æ–¹ç”»é¢é™éŸ³ï¼Œè§£è¯´æœ‰å£°ï¼‰');
    }, 1000);
  }
}

// ========== æŠ˜å é¢æ¿æ§åˆ¶ ==========
const STORAGE_KEY_COLLAPSED = 'audioPanel_collapsed';

function togglePanel() {
  const isCollapsed = audioPanel.classList.contains('collapsed');
  
  if (isCollapsed) {
    audioPanel.classList.remove('collapsed');
    audioPanel.classList.add('expanded');
    localStorage.setItem(STORAGE_KEY_COLLAPSED, 'false');
    if (toggleAudioBtn) {
      toggleAudioBtn.querySelector('.icon').textContent = 'â–¼';
    }
    log('å±•å¼€è§£è¯´é¢æ¿');
  } else {
    audioPanel.classList.remove('expanded');
    audioPanel.classList.add('collapsed');
    localStorage.setItem(STORAGE_KEY_COLLAPSED, 'true');
    if (toggleAudioBtn) {
      toggleAudioBtn.querySelector('.icon').textContent = 'â–²';
    }
    log('æŠ˜å è§£è¯´é¢æ¿');
  }
}

// æ¢å¤ä¸Šæ¬¡çš„æŠ˜å çŠ¶æ€
function restoreState() {
  const savedCollapsed = localStorage.getItem(STORAGE_KEY_COLLAPSED);
  
  if (savedCollapsed === 'false') {
    audioPanel.classList.remove('collapsed');
    audioPanel.classList.add('expanded');
    if (toggleAudioBtn) {
      toggleAudioBtn.querySelector('.icon').textContent = 'â–¼';
    }
    log('æ¢å¤å±•å¼€çŠ¶æ€');
  } else {
    audioPanel.classList.add('collapsed');
    audioPanel.classList.remove('expanded');
    if (toggleAudioBtn) {
      toggleAudioBtn.querySelector('.icon').textContent = 'â–²';
    }
    log('é»˜è®¤æŠ˜å çŠ¶æ€');
  }
}

// ç»‘å®šåˆ‡æ¢äº‹ä»¶
if (panelToggle) {
  panelToggle.onclick = (e) => {
    e.stopPropagation();
    togglePanel();
  };
}

if (toggleAudioBtn) {
  toggleAudioBtn.onclick = togglePanel;
}

if (panelHeader) {
  panelHeader.onclick = (e) => {
    if (e.target === panelHeader || e.target.classList.contains('panel-title')) {
      togglePanel();
    }
  };
}

// ========== åˆ·æ–°åŠŸèƒ½ ==========
function refreshMain() {
  log('åˆ·æ–°ä¸»ç”»é¢');
  videoFrame.src = videoFrame.src;
  if (statusDot) {
    statusDot.className = 'status-dot loading';
  }
  if (statusText) {
    statusText.textContent = 'åˆ·æ–°ä¸­';
  }
}

function refreshAudio() {
  log('åˆ·æ–°è§£è¯´ç”»é¢');
  audioFrame.src = audioFrame.src;
  
  // åˆ·æ–°åå†æ¬¡ç¡®ä¿æœ‰å£°éŸ³
  setTimeout(() => {
    try {
      audioFrame.contentWindow.postMessage({
        type: 'unmute',
        muted: false
      }, '*');
      log('åˆ·æ–°åé‡æ–°å‘é€å–æ¶ˆé™éŸ³æŒ‡ä»¤');
    } catch (e) {
      log('åˆ·æ–°åæ— æ³•æ§åˆ¶éŸ³é¢‘');
    }
  }, 1500);
}

if (refreshMainBtn) {
  refreshMainBtn.onclick = refreshMain;
}

if (refreshAudioBtn) {
  refreshAudioBtn.onclick = refreshAudio;
}

if (refreshAudioBtn2) {
  refreshAudioBtn2.onclick = refreshAudio;
}

// ========== ä½¿ç”¨è¯´æ˜å¼¹çª— ==========
if (helpBtn) {
  helpBtn.onclick = () => {
    modalOverlay.classList.add('show');
    log('æ‰“å¼€ä½¿ç”¨è¯´æ˜');
  };
}

if (modalClose) {
  modalClose.onclick = () => {
    modalOverlay.classList.remove('show');
    log('å…³é—­ä½¿ç”¨è¯´æ˜');
  };
}

if (modalOverlay) {
  modalOverlay.onclick = (e) => {
    if (e.target === modalOverlay) {
      modalOverlay.classList.remove('show');
      log('ç‚¹å‡»èƒŒæ™¯å…³é—­è¯´æ˜');
    }
  };
}

// ========== å¿«æ·é”®ï¼ˆä»…æ¡Œé¢ç«¯ï¼‰ ==========
if (!isMobile) {
  document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + Space åˆ‡æ¢è§£è¯´é¢æ¿
    if ((e.ctrlKey || e.metaKey) && e.code === 'Space') {
      e.preventDefault();
      togglePanel();
      log('å¿«æ·é”®åˆ‡æ¢é¢æ¿');
    }
    
    // ESC å¿«é€ŸæŠ˜å 
    if (e.code === 'Escape') {
      if (modalOverlay.classList.contains('show')) {
        modalOverlay.classList.remove('show');
        log('ESC å…³é—­ä½¿ç”¨è¯´æ˜');
      } else if (!audioPanel.classList.contains('collapsed')) {
        togglePanel();
        log('ESC å¿«é€ŸæŠ˜å ');
      }
    }
    
    // Ctrl+Shift+D åˆ‡æ¢è°ƒè¯•æ¨¡å¼
    if (e.ctrlKey && e.shiftKey && e.key === 'D') {
      e.preventDefault();
      debugEnabled = !debugEnabled;
      debugPanel.classList.toggle('show', debugEnabled);
      log(`è°ƒè¯•æ¨¡å¼: ${debugEnabled ? 'å¼€å¯' : 'å…³é—­'}`);
    }
    
    // Ctrl+R åˆ·æ–°ä¸»ç”»é¢
    if (e.ctrlKey && e.key === 'r' && !e.shiftKey) {
      e.preventDefault();
      refreshMain();
    }
    
    // Ctrl+Shift+R åˆ·æ–°è§£è¯´
    if (e.ctrlKey && e.shiftKey && e.key === 'R') {
      e.preventDefault();
      refreshAudio();
    }
  });
}

// ========== ç›‘å¬æ¥è‡ª iframe çš„æ¶ˆæ¯ ==========
window.addEventListener('message', (event) => {
  if (!event.origin.includes('bilibili.com')) {
    return;
  }
  
  try {
    const data = event.data;
    
    if (data.type === 'video_muted' && data.source === 'main') {
      log('ä¸»ç”»é¢ç¡®è®¤ï¼šå·²é™éŸ³');
    }
    
    if (data.type === 'video_muted' && data.source === 'audio') {
      if (data.muted) {
        log('è§£è¯´æ’­æ”¾å™¨æ„å¤–é™éŸ³ï¼Œå°è¯•æ¢å¤');
        audioFrame.contentWindow.postMessage({
          type: 'unmute',
          muted: false
        }, '*');
      } else {
        log('è§£è¯´æ’­æ”¾å™¨ç¡®è®¤ï¼šæœ‰å£°éŸ³');
      }
    }
  } catch (e) {
    // å¿½ç•¥è§£æé”™è¯¯
  }
});

// ========== é¡µé¢åŠ è½½å®Œæˆ ==========
window.addEventListener('load', () => {
  // æ¢å¤ä¸Šæ¬¡çš„çŠ¶æ€
  restoreState();
  
  // å»¶è¿Ÿå†æ¬¡ç¡®ä¿éŸ³é¢‘æœ‰å£°éŸ³
  setTimeout(() => {
    try {
      audioFrame.contentWindow.postMessage({
        type: 'unmute',
        muted: false,
        volume: 1.0
      }, '*');
      log('é¡µé¢åŠ è½½å®Œæˆåå†æ¬¡ç¡®ä¿è§£è¯´æœ‰å£°éŸ³');
    } catch (e) {
      log('æ— æ³•å‘é€éŸ³é¢‘æ§åˆ¶æ¶ˆæ¯');
    }
  }, 2000);
  
  log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
  log('å®˜æ–¹ç”»é¢ï¼šé™éŸ³æ¨¡å¼');
  log('ç‚«ç¥è§£è¯´ï¼šæœ‰å£°éŸ³ï¼ˆå·²å¼ºåˆ¶å–æ¶ˆé™éŸ³ï¼‰');
  
  if (!isMobile) {
    log('å¿«æ·é”®å·²å¯ç”¨');
  } else {
    log('ç§»åŠ¨ç«¯æ¨¡å¼');
  }
});

// ========== é¡µé¢å¯è§æ€§æ£€æµ‹ ==========
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    log('é¡µé¢åˆ‡æ¢åˆ°åå°');
  } else {
    log('é¡µé¢åˆ‡æ¢åˆ°å‰å°');
    
    // é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œå†æ¬¡ç¡®ä¿éŸ³é¢‘æœ‰å£°éŸ³
    setTimeout(() => {
      try {
        audioFrame.contentWindow.postMessage({
          type: 'unmute',
          muted: false
        }, '*');
        log('é¡µé¢æ¢å¤å¯è§ï¼Œé‡æ–°ç¡®ä¿è§£è¯´æœ‰å£°éŸ³');
      } catch (e) {
        log('æ— æ³•é‡æ–°æ§åˆ¶éŸ³é¢‘');
      }
    }, 500);
  }
});

// ========== è¶…æ—¶æ£€æµ‹ ==========
let loadTimer = setTimeout(() => {
  if (!videoLoaded || !audioLoaded) {
    log('éƒ¨åˆ†ç›´æ’­æµåŠ è½½è¶…æ—¶');
    if (statusDot) {
      statusDot.className = 'status-dot error';
    }
    if (statusText) {
      statusText.textContent = 'è¿æ¥è¶…æ—¶';
    }
  }
}, 15000);

if (videoLoaded && audioLoaded) {
  clearTimeout(loadTimer);
}

// ========== å®šæœŸæ£€æŸ¥éŸ³é¢‘çŠ¶æ€ ==========
setInterval(() => {
  if (audioLoaded) {
    try {
      audioFrame.contentWindow.postMessage({
        type: 'check_muted'
      }, '*');
    } catch (e) {
      // å¿½ç•¥é”™è¯¯
    }
  }
}, 30000);

// ========== ç§»åŠ¨ç«¯ç‰¹æ®Šå¤„ç† ==========
if (isMobile) {
  // ç¦æ­¢é¡µé¢æ»šåŠ¨
  document.body.style.overflow = 'hidden';
  document.documentElement.style.overflow = 'hidden';
  
  // ç¦æ­¢åŒå‡»ç¼©æ”¾
  let lastTouchEnd = 0;
  document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, { passive: false });
  
  // iOS Safari åœ°å€æ éšè—å¤„ç†
  if (isIOS) {
    window.addEventListener('load', () => {
      setTimeout(() => {
        window.scrollTo(0, 1);
        log('iOS: éšè—åœ°å€æ ');
      }, 100);
    });
    
    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        window.scrollTo(0, 1);
        log('iOS: å±å¹•æ—‹è½¬ï¼Œé‡æ–°è°ƒæ•´');
      }, 100);
    });
  }
  
  // é˜»æ­¢æ©¡çš®ç­‹æ•ˆæœ
  let startY = 0;
  document.addEventListener('touchstart', (e) => {
    startY = e.touches[0].pageY;
  }, { passive: true });
  
  document.addEventListener('touchmove', (e) => {
    const y = e.touches[0].pageY;
    const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
    
    if ((scrollTop <= 0 && y > startY) || 
        (scrollTop + window.innerHeight >= document.documentElement.scrollHeight && y < startY)) {
      if (!e.target.closest('.modal-body')) {
        e.preventDefault();
      }
    }
  }, { passive: false });
  
  // é˜»æ­¢é•¿æŒ‰èœå•
  document.addEventListener('contextmenu', (e) => {
    e.preventDefault();
  }, { passive: false });
  
  log('ç§»åŠ¨ç«¯ä¼˜åŒ–å·²å¯ç”¨');
}

// ========== ç½‘ç»œçŠ¶æ€ç›‘å¬ ==========
window.addEventListener('online', () => {
  log('ç½‘ç»œå·²è¿æ¥');
  if (statusDot) {
    statusDot.className = 'status-dot success';
  }
  if (statusText) {
    statusText.textContent = 'æ’­æ”¾ä¸­';
  }
});

window.addEventListener('offline', () => {
  log('ç½‘ç»œå·²æ–­å¼€');
  if (statusDot) {
    statusDot.className = 'status-dot error';
  }
  if (statusText) {
    statusText.textContent = 'ç½‘ç»œæ–­å¼€';
  }
});

// ========== å”¤é†’é”ï¼ˆé˜²æ­¢å±å¹•ä¼‘çœ ï¼‰ ==========
if ('wakeLock' in navigator && isMobile) {
  let wakeLock = null;
  
  const requestWakeLock = async () => {
    try {
      wakeLock = await navigator.wakeLock.request('screen');
      log('å±å¹•ä¿æŒå”¤é†’');
      
      wakeLock.addEventListener('release', () => {
        log('å±å¹•å”¤é†’å·²é‡Šæ”¾');
      });
    } catch (err) {
      log(`æ— æ³•å¯ç”¨å±å¹•å”¤é†’: ${err.message}`);
    }
  };
  
  document.addEventListener('visibilitychange', async () => {
    if (!document.hidden && wakeLock === null) {
      await requestWakeLock();
    }
  });
  
  requestWakeLock();
}

log('è„šæœ¬åˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…ç›´æ’­æµåŠ è½½');
</script>
</body>
</html>
