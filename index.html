<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>S15 原画 + 炫神解说</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  /* ========== Microsoft Fluent 风格设计 ========== */
  *{margin:0;padding:0;box-sizing:border-box}
  
  html, body{
    width:100%;
    height:100%;
    overflow:hidden;
    position:fixed;
    -webkit-overflow-scrolling:touch;
  }
  
  body{
    font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
    background:#000;
    color:#fff;
    display:flex;
    flex-direction:column;
    padding-top:env(safe-area-inset-top);
    padding-bottom:env(safe-area-inset-bottom);
    padding-left:env(safe-area-inset-left);
    padding-right:env(safe-area-inset-right);
  }
  
  /* ========== 顶部工具栏 ========== */
  header{
    background:#1f1f1f;
    border-bottom:1px solid #333;
    padding:0;
    display:flex;
    align-items:stretch;
    z-index:10;
    flex-shrink:0;
    height:48px;
  }
  
  /* 左侧状态区 */
  .header-left{
    display:flex;
    align-items:center;
    padding:0 16px;
    gap:12px;
    border-right:1px solid #333;
  }
  
  .status-badge{
    background:#c50f1f;
    color:#fff;
    padding:4px 10px;
    font-weight:600;
    font-size:11px;
    letter-spacing:0.5px;
    text-transform:uppercase;
  }
  
  .title-text{
    font-size:13px;
    font-weight:400;
    color:#e0e0e0;
    white-space:nowrap;
  }
  
  /* 中间控制区 */
  .header-center{
    display:flex;
    align-items:center;
    gap:0;
    flex:1;
    overflow-x:auto;
    overflow-y:hidden;
  }
  
  .header-center::-webkit-scrollbar{
    height:0;
  }
  
  /* 右侧状态区 */
  .header-right{
    display:flex;
    align-items:center;
    padding:0 16px;
    gap:8px;
    border-left:1px solid #333;
  }
  
  .status-indicator{
    display:flex;
    align-items:center;
    gap:8px;
    font-size:12px;
    color:#b0b0b0;
  }
  
  .status-dot{
    width:8px;
    height:8px;
    border-radius:50%;
    background:#6c6c6c;
  }
  .status-dot.loading{background:#f7b731;animation:pulse 1.5s infinite}
  .status-dot.success{background:#10b981}
  .status-dot.error{background:#c50f1f;animation:blink 1s infinite}
  
  @keyframes pulse{
    0%,100%{opacity:.5}
    50%{opacity:1}
  }
  @keyframes blink{
    0%,100%{opacity:1}
    50%{opacity:.3}
  }
  
  /* ========== 工具栏按钮 ========== */
  .toolbar-btn{
    height:48px;
    padding:0 16px;
    background:transparent;
    border:none;
    border-right:1px solid #333;
    color:#e0e0e0;
    font-size:13px;
    font-family:'Segoe UI',sans-serif;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:8px;
    transition:background .15s ease;
    white-space:nowrap;
    -webkit-tap-highlight-color:transparent;
  }
  
  .toolbar-btn:hover{
    background:#2d2d2d;
  }
  
  .toolbar-btn:active{
    background:#3d3d3d;
  }
  
  .toolbar-btn.primary{
    background:#0078d4;
    color:#fff;
    border-right:1px solid #005a9e;
  }
  
  .toolbar-btn.primary:hover{
    background:#106ebe;
  }
  
  .toolbar-btn.primary:active{
    background:#005a9e;
  }
  
  .toolbar-btn .icon{
    font-size:16px;
    font-weight:400;
  }
  
  /* ========== 主视频区域 ========== */
  .box{
    flex:1;
    display:flex;
    position:relative;
    overflow:hidden;
    min-height:0;
    background:#000;
  }
  
  iframe{
    width:100%;
    height:100%;
    border:0;
  }
  
  /* ========== 炫神解说折叠面板 ========== */
  .audio-panel{
    position:absolute;
    top:0;
    right:0;
    background:#1f1f1f;
    border-left:1px solid #333;
    border-bottom:1px solid #333;
    z-index:100;
    display:flex;
    flex-direction:column;
    transition:width .2s ease, height .2s ease;
    box-shadow:-2px 2px 8px rgba(0,0,0,.5);
  }
  
  .audio-panel.collapsed{
    width:200px;
    height:48px;
  }
  
  .audio-panel.expanded{
    width:400px;
    height:300px;
  }
  
  /* 面板标题栏 */
  .panel-header{
    height:48px;
    background:#2d2d2d;
    border-bottom:1px solid #333;
    display:flex;
    align-items:center;
    padding:0 16px;
    cursor:pointer;
    user-select:none;
  }
  
  .panel-header:hover{
    background:#3d3d3d;
  }
  
  .panel-title{
    flex:1;
    font-size:13px;
    font-weight:600;
    color:#e0e0e0;
  }
  
  .panel-toggle{
    width:32px;
    height:32px;
    background:transparent;
    border:1px solid #555;
    color:#e0e0e0;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    transition:all .15s ease;
  }
  
  .panel-toggle:hover{
    background:#3d3d3d;
    border-color:#666;
  }
  
  .audio-panel.collapsed .panel-toggle{
    transform:rotate(180deg);
  }
  
  /* 面板内容 */
  .panel-content{
    flex:1;
    display:flex;
    flex-direction:column;
    overflow:hidden;
    opacity:1;
    transition:opacity .2s ease;
  }
  
  .audio-panel.collapsed .panel-content{
    opacity:0;
    pointer-events:none;
  }
  
  .panel-player{
    flex:1;
    background:#000;
    border-bottom:1px solid #333;
  }
  
  .panel-controls{
    height:48px;
    display:flex;
    padding:8px;
    gap:8px;
    background:#1f1f1f;
  }
  
  .panel-btn{
    flex:1;
    height:32px;
    background:#0078d4;
    border:1px solid #005a9e;
    color:#fff;
    font-size:12px;
    font-family:'Segoe UI',sans-serif;
    cursor:pointer;
    transition:background .15s ease;
    -webkit-tap-highlight-color:transparent;
  }
  
  .panel-btn:hover{
    background:#106ebe;
  }
  
  .panel-btn:active{
    background:#005a9e;
  }
  
  /* ========== 模态弹窗（Microsoft 风格） ========== */
  .modal-overlay{
    position:fixed;
    top:0;
    left:0;
    right:0;
    bottom:0;
    background:rgba(0,0,0,.6);
    z-index:9999;
    display:none;
    align-items:center;
    justify-content:center;
    padding:20px;
  }
  
  .modal-overlay.show{
    display:flex;
  }
  
  .modal{
    background:#1f1f1f;
    border:1px solid #333;
    max-width:600px;
    width:100%;
    max-height:80vh;
    display:flex;
    flex-direction:column;
    box-shadow:0 8px 32px rgba(0,0,0,.8);
  }
  
  .modal-header{
    height:48px;
    padding:0 16px;
    background:#2d2d2d;
    border-bottom:1px solid #333;
    display:flex;
    align-items:center;
    justify-content:space-between;
  }
  
  .modal-title{
    font-size:14px;
    font-weight:600;
    color:#fff;
  }
  
  .modal-close{
    width:32px;
    height:32px;
    background:transparent;
    border:1px solid #555;
    color:#e0e0e0;
    font-size:16px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:all .15s ease;
    -webkit-tap-highlight-color:transparent;
  }
  
  .modal-close:hover{
    background:#3d3d3d;
    border-color:#666;
  }
  
  .modal-body{
    flex:1;
    overflow-y:auto;
    padding:24px;
    color:#e0e0e0;
    line-height:1.6;
  }
  
  .modal-body::-webkit-scrollbar{
    width:12px;
  }
  
  .modal-body::-webkit-scrollbar-track{
    background:#1f1f1f;
  }
  
  .modal-body::-webkit-scrollbar-thumb{
    background:#555;
    border:2px solid #1f1f1f;
  }
  
  .modal-body::-webkit-scrollbar-thumb:hover{
    background:#666;
  }
  
  /* 步骤列表 */
  .step{
    margin-bottom:24px;
    padding:16px;
    background:#2d2d2d;
    border-left:3px solid #0078d4;
  }
  
  .step-header{
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom:12px;
  }
  
  .step-number{
    width:28px;
    height:28px;
    background:#0078d4;
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:600;
    font-size:14px;
  }
  
  .step-title{
    font-weight:600;
    color:#fff;
    font-size:14px;
  }
  
  .step-desc{
    font-size:13px;
    color:#b0b0b0;
    line-height:1.7;
  }
  
  .step-desc strong{
    color:#e0e0e0;
  }
  
  /* 提示框 */
  .info-box{
    background:#2d2d2d;
    border:1px solid #555;
    padding:16px;
    margin-top:24px;
  }
  
  .info-box.warning{
    border-left:3px solid #f7b731;
  }
  
  .info-box.error{
    border-left:3px solid #c50f1f;
  }
  
  .info-title{
    font-weight:600;
    color:#fff;
    margin-bottom:12px;
    font-size:14px;
  }
  
  .info-list{
    font-size:13px;
    color:#b0b0b0;
    line-height:1.8;
    list-style:none;
    padding-left:0;
  }
  
  .info-list li{
    padding-left:20px;
    position:relative;
  }
  
  .info-list li:before{
    content:'▪';
    position:absolute;
    left:0;
    color:#0078d4;
  }
  
  .kbd{
    display:inline-block;
    padding:2px 6px;
    background:#3d3d3d;
    border:1px solid #555;
    font-size:11px;
    font-family:'Consolas','Courier New',monospace;
    color:#e0e0e0;
  }
  
  /* 调试日志 */
  .debug{
    position:fixed;
    top:60px;
    left:16px;
    background:#1f1f1f;
    border:1px solid #333;
    padding:12px;
    font-size:11px;
    font-family:'Consolas','Courier New',monospace;
    max-width:400px;
    max-height:300px;
    overflow-y:auto;
    color:#10b981;
    display:none;
    z-index:999;
  }
  .debug.show{display:block}
  .debug div{margin:2px 0}
  
  /* ========== 移动端适配 ========== */
  @media (max-width: 768px) {
    header{
      height:auto;
      flex-wrap:wrap;
    }
    
    .header-left{
      padding:8px 12px;
      height:44px;
    }
    
    .status-badge{
      font-size:10px;
      padding:3px 8px;
    }
    
    .title-text{
      font-size:12px;
    }
    
    .header-center{
      width:100%;
      border-top:1px solid #333;
      height:44px;
    }
    
    .toolbar-btn{
      height:44px;
      padding:0 12px;
      font-size:12px;
    }
    
    .header-right{
      display:none; /* 移动端隐藏状态指示器 */
    }
    
    /* 炫神解说面板在移动端固定底部 */
    .audio-panel{
      position:fixed;
      top:auto;
      bottom:0;
      left:0;
      right:0;
      border:none;
      border-top:1px solid #333;
    }
    
    .audio-panel.collapsed{
      width:100%;
      height:44px;
    }
    
    .audio-panel.expanded{
      width:100%;
      height:60vh;
      max-height:400px;
    }
    
    .panel-header{
      height:44px;
    }
    
    .modal{
      max-width:calc(100vw - 20px);
    }
    
    .modal-body{
      padding:16px;
    }
    
    .step{
      padding:12px;
      margin-bottom:16px;
    }
    
    .debug{
      display:none !important;
    }
    
    /* 🆕 确保播放器控制栏可见 */
    .box{
      padding-bottom:60px; /* 为炫神面板留出空间 */
    }
    
    .audio-panel.collapsed ~ .box{
      padding-bottom:44px;
    }
  }
  
  /* 横屏模式 */
  @media (max-width: 768px) and (orientation: landscape) {
    .audio-panel.expanded{
      height:80vh;
    }
  }
</style>
</head>
<body>

<!-- ========== 顶部工具栏 ========== -->
<header>
  <div class="header-left">
    <span class="status-badge">LIVE</span>
    <span class="title-text">S15 官方画面 + Last炫神解说</span>
  </div>
  
  <div class="header-center">
    <button class="toolbar-btn" id="toggleAudioBtn">
      <span class="icon">▲</span>
      <span>炫神解说</span>
    </button>
    
    <button class="toolbar-btn" id="refreshAudioBtn">
      <span class="icon">⟳</span>
      <span>刷新解说</span>
    </button>
    
    <button class="toolbar-btn" id="refreshMainBtn">
      <span class="icon">⟳</span>
      <span>刷新主画面</span>
    </button>
    
    <button class="toolbar-btn" id="helpBtn">
      <span class="icon">?</span>
      <span>使用说明</span>
    </button>
  </div>
  
  <div class="header-right">
    <div class="status-indicator">
      <span class="status-dot success" id="statusDot"></span>
      <span id="statusText">播放中</span>
    </div>
  </div>
</header>

<!-- ========== 主视频区域 ========== -->
<section class="box">
  <!-- 官方画面（静音） -->
  <iframe id="videoFrame"
          src="https://www.bilibili.com/blackboard/live/live-activity-player.html?cid=7734200&quality=1&muted=1"
          sandbox="allow-scripts allow-same-origin allow-presentation"
          allow="autoplay *; encrypted-media *; fullscreen *"
          referrerpolicy="no-referrer">
  </iframe>
  
  <!-- ========== 炫神解说折叠面板 ========== -->
  <div class="audio-panel collapsed" id="audioPanel">
    <div class="panel-header" id="panelHeader">
      <div class="panel-title">炫神解说直播间</div>
      <button class="panel-toggle" id="panelToggle">▲</button>
    </div>
    
    <div class="panel-content">
      <div class="panel-player">
        <iframe id="audioFrame"
                src="https://www.bilibili.com/blackboard/live/live-activity-player.html?cid=84074&quality=1"
                sandbox="allow-scripts allow-same-origin allow-presentation"
                allow="autoplay *; encrypted-media *"
                referrerpolicy="no-referrer"
                style="width:100%;height:100%;border:0">
        </iframe>
      </div>
      
      <div class="panel-controls">
        <button class="panel-btn" id="refreshAudioBtn2">刷新解说</button>
      </div>
    </div>
  </div>
</section>

<!-- ========== 使用说明弹窗 ========== -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">使用说明</div>
      <button class="modal-close" id="modalClose">×</button>
    </div>
    
    <div class="modal-body">
      <div class="step">
        <div class="step-header">
          <div class="step-number">1</div>
          <div class="step-title">观看双视角直播</div>
        </div>
        <div class="step-desc">
          大屏幕显示官方画面（无声音），右上角小窗口播放炫神解说（有声音）。<br>
          <strong>建议：进入后直接点击右下角全屏按钮观赏，体验最佳。</strong>
        </div>
      </div>
      
      <div class="step">
        <div class="step-header">
          <div class="step-number">2</div>
          <div class="step-title">展开/折叠解说窗口</div>
        </div>
        <div class="step-desc">
          点击顶部工具栏的 <strong>"炫神解说"</strong> 按钮，或点击右上角解说窗口的 <strong>▲</strong> 按钮，可以展开或折叠解说播放器。
        </div>
      </div>
      
      <div class="step">
        <div class="step-header">
          <div class="step-number">3</div>
          <div class="step-title">刷新播放器</div>
        </div>
        <div class="step-desc">
          • 如果主画面卡顿或黑屏，点击顶部 <strong>"刷新主画面"</strong> 按钮<br>
          • 如果解说无声音或卡顿，点击顶部 <strong>"刷新解说"</strong> 按钮
        </div>
      </div>
      
            <div class="step">
        <div class="step-header">
          <div class="step-number">4</div>
          <div class="step-title">全屏观看</div>
        </div>
        <div class="step-desc">
          <strong>电脑端：</strong>点击播放器右下角的全屏按钮<br>
          <strong>手机端：</strong>建议横屏观看，竖屏时需要先展开解说窗口才能看到全屏按钮
        </div>
      </div>
      
      <div class="step">
        <div class="step-header">
          <div class="step-number">5</div>
          <div class="step-title">快捷键（仅电脑端）</div>
        </div>
        <div class="step-desc">
          <span class="kbd">Ctrl</span> + <span class="kbd">Space</span> 切换解说窗口<br>
          <span class="kbd">ESC</span> 快速折叠解说窗口<br>
          <span class="kbd">Ctrl</span> + <span class="kbd">R</span> 刷新主画面<br>
          <span class="kbd">Ctrl</span> + <span class="kbd">Shift</span> + <span class="kbd">R</span> 刷新解说
        </div>
      </div>
      
      <div class="info-box warning">
        <div class="info-title">注意事项</div>
        <ul class="info-list">
          <li>主画面默认静音，声音来自炫神解说窗口</li>
          <li>首次加载可能需要等待几秒钟</li>
          <li>移动端建议使用横屏观看以获得最佳体验</li>
          <li>如遇到加载问题，请尝试刷新页面</li>
        </ul>
      </div>
      
      <div class="info-box error">
        <div class="info-title">常见问题解决</div>
        <ul class="info-list">
          <li><strong>解说没声音？</strong> 点击"刷新解说"按钮</li>
          <li><strong>画面黑屏？</strong> 点击"刷新主画面"按钮</li>
          <li><strong>画面卡顿？</strong> 检查网络连接，尝试刷新页面</li>
          <li><strong>移动端控制栏被遮挡？</strong> 横屏观看或折叠解说窗口</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- 调试日志 -->
<div class="debug" id="debug"></div>

<script>
// ========== 调试日志系统 ==========
const debugPanel = document.getElementById('debug');
let debugEnabled = false;

function log(msg) {
  const now = new Date().toLocaleTimeString();
  console.log(`[${now}] ${msg}`);
  
  if (debugEnabled) {
    debugPanel.classList.add('show');
    const div = document.createElement('div');
    div.textContent = `${now} ${msg}`;
    debugPanel.appendChild(div);
    debugPanel.scrollTop = debugPanel.scrollHeight;
  }
}

log('页面开始加载');

// ========== 检测设备类型 ==========
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
log(`设备类型: ${isMobile ? '移动端' : '桌面端'}, iOS: ${isIOS}`);

// ========== DOM 元素 ==========
const videoFrame = document.getElementById('videoFrame');
const audioFrame = document.getElementById('audioFrame');
const audioPanel = document.getElementById('audioPanel');
const panelToggle = document.getElementById('panelToggle');
const panelHeader = document.getElementById('panelHeader');
const toggleAudioBtn = document.getElementById('toggleAudioBtn');
const refreshMainBtn = document.getElementById('refreshMainBtn');
const refreshAudioBtn = document.getElementById('refreshAudioBtn');
const refreshAudioBtn2 = document.getElementById('refreshAudioBtn2');
const helpBtn = document.getElementById('helpBtn');
const modalOverlay = document.getElementById('modalOverlay');
const modalClose = document.getElementById('modalClose');
const statusDot = document.getElementById('statusDot');
const statusText = document.getElementById('statusText');

// ========== 加载状态 ==========
let videoLoaded = false;
let audioLoaded = false;

videoFrame.onload = () => {
  videoLoaded = true;
  log('官方画面加载完成（静音）');
  checkBothLoaded();
};

audioFrame.onload = () => {
  audioLoaded = true;
  log('解说音频加载完成');
  
  // 确保音频有声音
  setTimeout(() => {
    try {
      audioFrame.contentWindow.postMessage({
        type: 'unmute',
        muted: false
      }, '*');
      log('已发送取消静音指令到解说播放器');
    } catch (e) {
      log('无法直接控制音频: ' + e.message);
    }
  }, 1000);
  
  checkBothLoaded();
};

audioFrame.onerror = () => {
  log('音频加载失败');
  if (statusDot) {
    statusDot.className = 'status-dot error';
  }
  if (statusText) {
    statusText.textContent = '加载失败';
  }
};

function checkBothLoaded() {
  if (videoLoaded && audioLoaded) {
    log('两个直播流都已加载');
    
    setTimeout(() => {
      if (statusDot) {
        statusDot.className = 'status-dot success';
      }
      if (statusText) {
        statusText.textContent = '播放中';
      }
      log('直播播放中（官方画面静音，解说有声）');
    }, 1000);
  }
}

// ========== 折叠面板控制 ==========
const STORAGE_KEY_COLLAPSED = 'audioPanel_collapsed';

function togglePanel() {
  const isCollapsed = audioPanel.classList.contains('collapsed');
  
  if (isCollapsed) {
    audioPanel.classList.remove('collapsed');
    audioPanel.classList.add('expanded');
    localStorage.setItem(STORAGE_KEY_COLLAPSED, 'false');
    if (toggleAudioBtn) {
      toggleAudioBtn.querySelector('.icon').textContent = '▼';
    }
    log('展开解说面板');
  } else {
    audioPanel.classList.remove('expanded');
    audioPanel.classList.add('collapsed');
    localStorage.setItem(STORAGE_KEY_COLLAPSED, 'true');
    if (toggleAudioBtn) {
      toggleAudioBtn.querySelector('.icon').textContent = '▲';
    }
    log('折叠解说面板');
  }
}

// 恢复上次的折叠状态
function restoreState() {
  const savedCollapsed = localStorage.getItem(STORAGE_KEY_COLLAPSED);
  
  if (savedCollapsed === 'false') {
    audioPanel.classList.remove('collapsed');
    audioPanel.classList.add('expanded');
    if (toggleAudioBtn) {
      toggleAudioBtn.querySelector('.icon').textContent = '▼';
    }
    log('恢复展开状态');
  } else {
    audioPanel.classList.add('collapsed');
    audioPanel.classList.remove('expanded');
    if (toggleAudioBtn) {
      toggleAudioBtn.querySelector('.icon').textContent = '▲';
    }
    log('默认折叠状态');
  }
}

// 绑定切换事件
if (panelToggle) {
  panelToggle.onclick = (e) => {
    e.stopPropagation();
    togglePanel();
  };
}

if (toggleAudioBtn) {
  toggleAudioBtn.onclick = togglePanel;
}

if (panelHeader) {
  panelHeader.onclick = (e) => {
    if (e.target === panelHeader || e.target.classList.contains('panel-title')) {
      togglePanel();
    }
  };
}

// ========== 刷新功能 ==========
function refreshMain() {
  log('刷新主画面');
  videoFrame.src = videoFrame.src;
  if (statusDot) {
    statusDot.className = 'status-dot loading';
  }
  if (statusText) {
    statusText.textContent = '刷新中';
  }
}

function refreshAudio() {
  log('刷新解说画面');
  audioFrame.src = audioFrame.src;
  
  // 刷新后再次确保有声音
  setTimeout(() => {
    try {
      audioFrame.contentWindow.postMessage({
        type: 'unmute',
        muted: false
      }, '*');
      log('刷新后重新发送取消静音指令');
    } catch (e) {
      log('刷新后无法控制音频');
    }
  }, 1500);
}

if (refreshMainBtn) {
  refreshMainBtn.onclick = refreshMain;
}

if (refreshAudioBtn) {
  refreshAudioBtn.onclick = refreshAudio;
}

if (refreshAudioBtn2) {
  refreshAudioBtn2.onclick = refreshAudio;
}

// ========== 使用说明弹窗 ==========
if (helpBtn) {
  helpBtn.onclick = () => {
    modalOverlay.classList.add('show');
    log('打开使用说明');
  };
}

if (modalClose) {
  modalClose.onclick = () => {
    modalOverlay.classList.remove('show');
    log('关闭使用说明');
  };
}

if (modalOverlay) {
  modalOverlay.onclick = (e) => {
    if (e.target === modalOverlay) {
      modalOverlay.classList.remove('show');
      log('点击背景关闭说明');
    }
  };
}

// ========== 快捷键（仅桌面端） ==========
if (!isMobile) {
  document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + Space 切换解说面板
    if ((e.ctrlKey || e.metaKey) && e.code === 'Space') {
      e.preventDefault();
      togglePanel();
      log('快捷键切换面板');
    }
    
    // ESC 快速折叠
    if (e.code === 'Escape') {
      if (modalOverlay.classList.contains('show')) {
        modalOverlay.classList.remove('show');
        log('ESC 关闭使用说明');
      } else if (!audioPanel.classList.contains('collapsed')) {
        togglePanel();
        log('ESC 快速折叠');
      }
    }
    
    // Ctrl+Shift+D 切换调试模式
    if (e.ctrlKey && e.shiftKey && e.key === 'D') {
      e.preventDefault();
      debugEnabled = !debugEnabled;
      debugPanel.classList.toggle('show', debugEnabled);
      log(`调试模式: ${debugEnabled ? '开启' : '关闭'}`);
    }
    
    // Ctrl+R 刷新主画面
    if (e.ctrlKey && e.key === 'r' && !e.shiftKey) {
      e.preventDefault();
      refreshMain();
    }
    
    // Ctrl+Shift+R 刷新解说
    if (e.ctrlKey && e.shiftKey && e.key === 'R') {
      e.preventDefault();
      refreshAudio();
    }
  });
}

// ========== 监听来自 iframe 的消息 ==========
window.addEventListener('message', (event) => {
  if (!event.origin.includes('bilibili.com')) {
    return;
  }
  
  try {
    const data = event.data;
    
    if (data.type === 'video_muted' && data.source === 'main') {
      log('主画面确认：已静音');
    }
    
    if (data.type === 'video_muted' && data.source === 'audio') {
      if (data.muted) {
        log('解说播放器意外静音，尝试恢复');
        audioFrame.contentWindow.postMessage({
          type: 'unmute',
          muted: false
        }, '*');
      } else {
        log('解说播放器确认：有声音');
      }
    }
  } catch (e) {
    // 忽略解析错误
  }
});

// ========== 页面加载完成 ==========
window.addEventListener('load', () => {
  // 恢复上次的状态
  restoreState();
  
  // 延迟再次确保音频有声音
  setTimeout(() => {
    try {
      audioFrame.contentWindow.postMessage({
        type: 'unmute',
        muted: false,
        volume: 1.0
      }, '*');
      log('页面加载完成后再次确保解说有声音');
    } catch (e) {
      log('无法发送音频控制消息');
    }
  }, 2000);
  
  log('页面初始化完成');
  log('官方画面：静音模式');
  log('炫神解说：有声音（已强制取消静音）');
  
  if (!isMobile) {
    log('快捷键已启用');
  } else {
    log('移动端模式');
  }
});

// ========== 页面可见性检测 ==========
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    log('页面切换到后台');
  } else {
    log('页面切换到前台');
    
    // 页面重新可见时，再次确保音频有声音
    setTimeout(() => {
      try {
        audioFrame.contentWindow.postMessage({
          type: 'unmute',
          muted: false
        }, '*');
        log('页面恢复可见，重新确保解说有声音');
      } catch (e) {
        log('无法重新控制音频');
      }
    }, 500);
  }
});

// ========== 超时检测 ==========
let loadTimer = setTimeout(() => {
  if (!videoLoaded || !audioLoaded) {
    log('部分直播流加载超时');
    if (statusDot) {
      statusDot.className = 'status-dot error';
    }
    if (statusText) {
      statusText.textContent = '连接超时';
    }
  }
}, 15000);

if (videoLoaded && audioLoaded) {
  clearTimeout(loadTimer);
}

// ========== 定期检查音频状态 ==========
setInterval(() => {
  if (audioLoaded) {
    try {
      audioFrame.contentWindow.postMessage({
        type: 'check_muted'
      }, '*');
    } catch (e) {
      // 忽略错误
    }
  }
}, 30000);

// ========== 移动端特殊处理 ==========
if (isMobile) {
  // 禁止页面滚动
  document.body.style.overflow = 'hidden';
  document.documentElement.style.overflow = 'hidden';
  
  // 禁止双击缩放
  let lastTouchEnd = 0;
  document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, { passive: false });
  
  // iOS Safari 地址栏隐藏处理
  if (isIOS) {
    window.addEventListener('load', () => {
      setTimeout(() => {
        window.scrollTo(0, 1);
        log('iOS: 隐藏地址栏');
      }, 100);
    });
    
    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        window.scrollTo(0, 1);
        log('iOS: 屏幕旋转，重新调整');
      }, 100);
    });
  }
  
  // 阻止橡皮筋效果
  let startY = 0;
  document.addEventListener('touchstart', (e) => {
    startY = e.touches[0].pageY;
  }, { passive: true });
  
  document.addEventListener('touchmove', (e) => {
    const y = e.touches[0].pageY;
    const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
    
    if ((scrollTop <= 0 && y > startY) || 
        (scrollTop + window.innerHeight >= document.documentElement.scrollHeight && y < startY)) {
      if (!e.target.closest('.modal-body')) {
        e.preventDefault();
      }
    }
  }, { passive: false });
  
  // 阻止长按菜单
  document.addEventListener('contextmenu', (e) => {
    e.preventDefault();
  }, { passive: false });
  
  log('移动端优化已启用');
}

// ========== 网络状态监听 ==========
window.addEventListener('online', () => {
  log('网络已连接');
  if (statusDot) {
    statusDot.className = 'status-dot success';
  }
  if (statusText) {
    statusText.textContent = '播放中';
  }
});

window.addEventListener('offline', () => {
  log('网络已断开');
  if (statusDot) {
    statusDot.className = 'status-dot error';
  }
  if (statusText) {
    statusText.textContent = '网络断开';
  }
});

// ========== 唤醒锁（防止屏幕休眠） ==========
if ('wakeLock' in navigator && isMobile) {
  let wakeLock = null;
  
  const requestWakeLock = async () => {
    try {
      wakeLock = await navigator.wakeLock.request('screen');
      log('屏幕保持唤醒');
      
      wakeLock.addEventListener('release', () => {
        log('屏幕唤醒已释放');
      });
    } catch (err) {
      log(`无法启用屏幕唤醒: ${err.message}`);
    }
  };
  
  document.addEventListener('visibilitychange', async () => {
    if (!document.hidden && wakeLock === null) {
      await requestWakeLock();
    }
  });
  
  requestWakeLock();
}

log('脚本初始化完成，等待直播流加载');
</script>
</body>
</html>
